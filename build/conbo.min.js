(function(n,t){var i=function(i,r){
/*! 
 * Conbo.js: Lightweight MVC application framework for JavaScript
 * http://conbojs.mesmotronic.com/
 * 
 * Copyright (c) 2013 Mesmotronic Limited
 * Released under the MIT license
 * http://www.mesmotronic.com/legal/mit
 */
var u={VERSION:"1.0.16",_:i,$:r},o,h,c,e,l,a,y;u.toString=function(){return"[Conbo "+this.VERSION+"]"},u.Class=function(n){this._inject(n),this.initialize.apply(this,arguments)},u.Class.prototype={initialize:function(){},callLater:function(n){return i.defer(this.bind.apply(this,[n].concat(i.rest(arguments)))),this},callSuper:function(n){return this._super[n]?this._super[n].apply(this,i.rest(arguments)):t},defineProperty:function(n,i,r,u){if(!("defineProperty"in Object))throw new Error("Object.defineProperty is not supported by the current browser");return i=i||function(){return this["_"+n]},r=r||function(t){this["_"+n]=t},Object.defineProperty(this,n,{enumerable:!0,configurable:!0,get:i,set:r}),u!==t&&(this[n]=u),this},defineAccessor:function(n,i,r,u){return i=i||function(){return this["_"+n]},r=r||function(t){return this["_"+n]=t,this},this[n]=function(){return(arguments.length?r:i).apply(this,arguments)},u!==t&&this[n](u),this},bind:function(n){return i.bind.apply(i,[n,this].concat(i.rest(arguments)))},bindAll:function(){return i.bindAll.apply(i,[this].concat(i.toArray(arguments))),this},_inject:function(n){return this.options=i.defaults(n||{},this.options),this.context||(this.context=this.options.context),this.context&&this.context.injectSingletons(this),this}},u.Class.extend=function(n,t){var r,u=this,f;return r=n&&i.has(n,"constructor")?n.constructor:function(){return u.apply(this,arguments)},i.extend(r,u,t),f=function(){this.constructor=r},f.prototype=u.prototype,r.prototype=new f,n&&i.extend(r.prototype,n),r.prototype._super=u.prototype,r},Array.prototype.indexOf||(Array.prototype.indexOf=function(n,t){return i.indexOf(this,obj,t)}),Array.prototype.forEach||(Array.prototype.forEach=function(n,t){i.each(this,n,t)}),String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),u.Event=u.Class.extend({constructor:function(n){if(i.isString(n)?this.type=n:i.defaults(this,n),!this.type)throw new Error("Invalid or undefined event type");this.initialize.apply(this,arguments)},initialize:function(){},clone:function(){return i.clone(this)},preventDefault:function(){this.defaultPrevented=!0},stopPropagation:function(){this.cancelBubble=!0},stopImmediatePropagation:function(){this.immediatePropagationStopped=!0,this.stopPropagation()},toString:function(){return"[conbo.Event]"}},{ALL:"all",all:function(n){var r=[],t;for(t in this)i.isString(this[t])&&this[t]!=this.ALL&&r.push(this[t]);return n?r:r.join(" ")}}),u.ConboEvent=u.Event.extend({initialize:function(n,t){i.defaults(this,t)},toString:function(){return"[conbo.ConboEvent]"}},{ERROR:"error",INVALID:"invalid",CHANGE:"change",ADD:"add",REMOVE:"remove",DESTROY:"destroy",RESET:"reset",SORT:"sort",REQUEST:"request",SYNC:"sync",ROUTE:"route",ALL:"all"}),u.EventDispatcher=u.Class.extend({trigger:function(n){var r,f,e,t,o;if(!n)throw new Error("Event undefined");if((!i.isString(n)&&n instanceof u.Event||(n=new u.Event(n)),!this._queue||!(n.type in this._queue)&&!this._queue.all)||(n.target||(n.target=this),n.currentTarget=this,r=i.union(this._queue[n.type]||[],this._queue.all||[]),!r||!r.length))return this;for(f=0,e=r.length;f<e;++f)if(t=r[f],o=t.handler.call(t.scope||this,n),t.once&&this._off(n.type,t.handler,t.scope),o===!1||n.immediatePropagationStopped)break;return this},on:function(n,t,r,u){if(!n)throw new Error("Event type undefined");if(!t||!i.isFunction(t))throw new Error("Event handler is undefined or not a function");return i.isString(n)&&(n=n.split(" ")),i.isArray(n)?i.each(n,function(n){this._on(n,t,r,u,!1)},this):i.each(n,function(n,t){this._on(t,n,r,u,!1)},this),this},one:function(n,t,r,u){if(!n)throw new Error("Event type undefined");if(!t||!i.isFunction(t))throw new Error("Event handler is undefined or not a function");return i.isString(n)&&(n=n.split(" ")),i.isArray(n)?i.each(n,function(n){this._on(n,t,r,u,!0)},this):i.each(n,function(n,t){this._on(t,n,r,u,!0)},this),this},off:function(n,t){if(!arguments.length)return this._queue={},this;if(!n)throw new Error("Event type undefined");if(arguments.length==2&&!t)return this;var r=arguments;return i.isString(n)&&(n=n.split(" ")),i.isArray(n)?i.each(n,function(){this._off.apply(this,r)},this):i.each(n,function(){this._off.apply(this,r)},this),this},toString:function(){return"[conbo.EventDispatcher]"},addEventListener:function(){this.on.apply(this,arguments)},removeEventListener:function(){this.off.apply(this,arguments)},_on:function(n,t,i,r,u){n=="*"&&(n="all"),this._queue||(this._queue={}),this._off(n,t,i),n in this._queue||(this._queue[n]=[]),this._queue[n].push({handler:t,scope:i,once:u,priority:r||0}),this._queue[n].sort(function(n,t){return t.priority-n.priority})},_off:function(n,t,i){var u,r;if(!this._queue||!(n in this._queue))return this;if(u=this._queue[n],arguments.length==1)return delete this._queue[n],this;for(r=0;r<u.length;r++)u[r].handler!=t&&u[r].handler||u[r].scope!=i&&u[r].scope||u.splice(r--,1);return this}}),u.Bindable=u.EventDispatcher.extend({get:function(n){var t=i.result(this,"_attributes");return i.result(t,n)},set:function(n,t,r){var f=i.result(this,"_attributes"),e,r;return i.isObject(n)?(i.each(n,function(n,t){this.set(t,n,r)},this),this):(e=!1,r||(r={silent:!1}),r.unset?(e=i.has(f,n),delete f[n]):i.isFunction(f[n])&&f[n]()!=t?(f[n](t),e=!0):f[n]!=t&&(f[n]=t,e=!0),e&&!r.silent&&(r={attribute:n,value:t,options:r},this.trigger(new u.ConboEvent("change:"+n,r)),this.trigger(new u.ConboEvent(u.ConboEvent.CHANGE,r))),this)},unset:function(n,r){return r=i.defaults({unset:!0},r),this.set(n,t,r)},toString:function(){return"[conbo.Bindable]"},_attributes:function(){return this}}),u.Context=u.EventDispatcher.extend({constructor:function(n){this._commands={},this._singletons={},this.options=n||{},this.view=this.options.view;this.on(u.Event.ALL,this._allHandler);return this.initialize.apply(this,arguments),this},initialize:function(){},mapCommand:function(n,t){if(!n)throw new Error("eventType cannot be undefined");if(!t)throw new Error("commandClass cannot be undefined");if(!this._mapMulti(n,t,this.mapCommand))return this._commands[n]&&this._commands[n].indexOf(t)!=-1?void 0:(this._commands[n]=this._commands[n]||[],this._commands[n].push(t),this)},unmapCommand:function(n,i){if(!n)throw new Error("eventType cannot be undefined");if(!this._mapMulti(n,i,this.unmapCommand)){if(i===t){delete this._commands[n];return}if(this._commands[n]){var r=this._commands[n].indexOf(i);if(r!=-1)return this._commands[n].splice(r,1),this}}},mapSingleton:function(n,t){if(!n)throw new Error("propertyName cannot be undefined");if(!t)throw new Error("singletonClass cannot be undefined");if(!this._mapMulti(n,t,this.mapSingleton))return this._singletons[n]=i.isFunction(t)?new t(arguments[2],arguments[3],arguments[4]):t,this},unmapSingleton:function(n){if(!n)throw new Error("propertyName cannot be undefined");if(!this._mapMulti(n,null,this.unmapSingleton))return this._singletons[n]?(delete this._singletons[n],this):void 0},addTo:function(n){return i.extend(n||{},{context:this})},injectSingletons:function(n){for(var i in n)n[i]===t&&(n[i]=this._singletons[i]);return this},toString:function(){return"[conbo.Context]"},_allHandler:function(n){var t=i.union(this._commands.all||[],this._commands[n.type]||[]);t.length&&i.each(t,function(t){this._executeCommand(t,n)},this)},_executeCommand:function(n,t){var i,r;return r={event:t},i=new n(this.addTo(r)),i.execute(),i=null,this},_mapMulti:function(n,t,r){if(i.isArray(n)||n.indexOf(" ")==-1)return!1;var u=i.isArray(n)?n:n.split(" ");return i.each(u,function(n){r(n,t)},this),!0}}),u.Map=u.Bindable.extend({constructor:function(n,t){this._inject(t),this._attributes=i.defaults({},n,i.result(this,"defaults")),this.initialize.apply(this,arguments)},toJSON:function(){return i.clone(this._attributes)},toString:function(){return"[conbo.Map]"}}),o=["keys","values","pairs","invert","pick","omit","size"],i.each(o,function(n){u.Map.prototype[n]=function(){return i[n].apply(i,[this._attributes].concat(i.rest(arguments)))}}),u.BindingUtils=u.Class.extend({},{bindElement:function(n,t,i,f){if(!(n instanceof u.Bindable))throw new Error("Source is not Bindable");return f=f||function(n){return typeof n=="undefined"?"":String(n)},r(i).each(function(i,u){var e=r(u),o=e[0].tagName,s;switch(o){case"INPUT":case"SELECT":case"TEXTAREA":s=(e.attr("type")||o).toLowerCase();switch(s){case"checkbox":e.prop("checked",Boolean(n.get(t)));n.on("change:"+t,function(n){e.prop("checked",Boolean(n.value))});e.on("input change",function(){n.set(t,e.is(":checked"))});return;case"radio":e.val()==n.get(t)&&e.prop("checked",!0);n.on("change:"+t,function(n){e.val()==n.value&&e.prop("checked",!0)});break;default:e.val(n.get(t));n.on("change:"+t,function(n){e.val()!=n.value&&e.val(n.value)})}e.on("input change",function(){n.set(t,e.val()||e.html())});break;default:e.html(f(n.get(t)));n.on("change:"+t,function(n){var t=f(n.value);e.html(t)})}}),this},bindProperty:function(n,t,i,r,f){if(!(n instanceof u.Bindable))throw new Error("Source is not Bindable");r=r||t;n.on("change:"+t,function(n){i.get(r)!==n.value&&i.set(r,n.value)});return f&&this.bindProperty(i,r,n,t),this},bindSetter:function(n,t,i){if(!(n instanceof u.Bindable))throw new Error("Source is not Bindable");n.on("change:"+t,function(n){i(n.value)});return this}}),h=/^(\S+)\s*(.*)$/,c=["model","collection","el","id","attributes","className","tagName","events"],u.View=u.Bindable.extend({constructor:function(n){this.cid=i.uniqueId("view"),this._addStyle(),this._configure(n||{}),this._ensureElement(),this._inject(n),this.initialize.apply(this,arguments),this.delegateEvents()},tagName:"div",$:function(n){return this.$el.find(n)},initialize:function(){},render:function(){return this},remove:function(){return this.$el.remove(),this.unbindView().off(),this},setElement:function(n,t){return this.$el&&this.undelegateEvents().unbindView(),this.$el=n instanceof u.$?n:u.$(n),this.el=this.$el[0],t!==!1&&this.delegateEvents(),this instanceof u.Application||this.bindView(),this},appendView:function(n){if(arguments.length>1)return i.each(arguments,function(n){this.appendView(n)},this),this;if(!(n instanceof u.View))throw new Error("Parameter must be instance of conbo.View class");return this.$el.append(n.el),this},prependView:function(n){if(arguments.length>1)return i.each(arguments,function(n){this.prependView(n)},this),this;if(!(n instanceof u.View))throw new Error("Parameter must be instance of conbo.View class");return this.$el.prepend(n.el),this},mouseEnabled:function(){return this._setClass.apply(this,i.union(["conbo-disabled"],i.toArray(arguments)))},visible:function(){return this._setClass.apply(this,i.union(["conbo-invisible"],i.toArray(arguments)))},includeInLayout:function(){return this._setClass.apply(this,i.union(["conbo-excludeFromLayout"],i.toArray(arguments)))},bindView:function(){return this.$("[data-property]").each(this.bind(function(n,i){var r=this.$(i).data(),e;if(p=r.property,s=r.source,f=typeof this[r.parse]=="function"?this[r.parse]:t,!!s&&!(s in this))throw new Error("Unable to bind element to undefined source: "+s);e=!s?this:this[s],u.BindingUtils.bindElement(e,p,i,f)})),this},unbindView:function(){return this},loadCSS:function(t){if("document"in n){var i;return i=document.createElement("link"),i.type="text/css",i.rel="stylesheet",i.href=t,document.getElementsByTagName("head")[0].appendChild(i),this}},delegateEvents:function(n){var r,t;if(n||(n=i.result(this,"events"))){this.undelegateEvents();for(r in n){if(t=n[r],i.isFunction(t)||(t=this[n[r]]),!t)throw new Error('Method "'+n[r]+'" does not exist');var f=r.match(h),u=f[1],e=f[2];if(t=i.bind(t,this),u+=".delegateEvents"+this.cid,e==="")this.$el.on(u,t);else this.$el.on(u,e,t)}return this}},undelegateEvents:function(){return this.$el.off(".delegateEvents"+this.cid),this},toString:function(){return"[conbo.View]"},_addStyle:function(){if(!!u.style)return this;var n=u.$('<style type="text/css">.conbo-invisible { visibility:hidden !important; }.conbo-excludeFromLayout { display:none !important; }.conbo-disabled { pointer-events:none !important; }<\/style>');return u.$("head").append(n),u.style=n,this},_configure:function(n){this.options&&(n=i.extend({},i.result(this,"options"),n)),i.extend(this,i.pick(n,c)),this.options=n},_ensureElement:function(){var n,t;this.el?(this.setElement(i.result(this,"el"),!1),this.className&&this.$el.addClass(this.className)):(n=i.extend({},i.result(this,"attributes")),this.id&&(n.id=i.result(this,"id")),this.className&&(n["class"]=i.result(this,"className")),t=u.$("<"+i.result(this,"tagName")+">").attr(n),this.setElement(t,!1))},_setClass:function(n,t){var r=i.rest(arguments),f,e;return r.length?(f=i.isString(t)||i.isElement(t)||t instanceof u.$,e=f?this.$(t):this.$el,r.length==1&&f)?!e.hasClass(n):(r.length==2&&f&&(t=r[1]),e.removeClass(n),t||e.addClass(n),this):!this.$el.hasClass(n)}}),u.Actor=u.Bindable.extend({constructor:function(n){this._inject(n),this.initialize.apply(this,arguments)}}),u.Application=u.View.extend({contextClass:u.Context,constructor:function(n){n=n||{},n.view=n.view||this,this.context=n.context||new this.contextClass(n),u.View.prototype.constructor.apply(this,arguments)},toString:function(){return"[conbo.Application]"}}),u.Command=u.EventDispatcher.extend({constructor:function(n){this._inject(n),this.event=this.options.event||{},this.initialize.apply(this,arguments)},initialize:function(){},execute:function(){},toString:function(){return"[conbo.Command]"}}),u.ServerApplication=u.Bindable.extend({contextClass:u.Context,constructor:function(n){n=n||{},n.view=n.view||this,this.context=n.context||new this.contextClass(n),this._inject(n),this.options=n,this.initialize.apply(this,arguments)},initialize:function(){},toString:function(){return"[conbo.ServerApplication]"}}),u.Model=u.Map.extend({constructor:function(n,t){var r=n||{};t||(t={}),this.cid=i.uniqueId("c"),this._attributes={},i.extend(this,i.pick(t,["url","urlRoot","collection"])),t.parse&&(r=this.parse(r,t)||{}),r=i.defaults({},r,i.result(this,"defaults")),this.set(r,t),this._inject(t),this.initialize.apply(this,arguments)},changed:null,validationError:null,idAttribute:"id",initialize:function(){},sync:function(){return u.sync.apply(this,arguments)},get:function(n){return this._attributes[n]},escape:function(n){return i.escape(this.get(n))},has:function(n){return this.get(n)!=null},set:function(n,t,r){var f,e,a,o,c,l,v,h,s,y;if(n==null)return this;if(typeof n=="object"?(e=n,r=t):(e={})[n]=t,r||(r={}),!this._validate(e,r))return!1;a=r.unset,c=r.silent,o=[],l=this._changing,this._changing=!0,l||(this._previousAttributes=i.clone(this._attributes),this.changed={}),h=this._attributes,v=this._previousAttributes,this.idAttribute in e&&(this.id=e[this.idAttribute]);for(f in e)t=e[f],i.isEqual(h[f],t)||o.push(f),i.isEqual(v[f],t)?delete this.changed[f]:this.changed[f]=t,a?delete h[f]:h[f]=t;if(!c)for(o.length&&(this._pending=!0),s=0,y=o.length;s<y;s++)this.trigger(new u.ConboEvent("change:"+o[s],{model:this,value:h[o[s]],options:r,attribute:o[s]}));if(l)return this;if(!c)while(this._pending)this._pending=!1,this.trigger(new u.ConboEvent(u.ConboEvent.CHANGE,{model:this,options:r}));return this._pending=!1,this._changing=!1,this},unset:function(n,t){return this.set(n,void 0,i.extend({},t,{unset:!0}))},clear:function(n){var t={},r;for(r in this._attributes)t[r]=void 0;return this.set(t,i.extend({},n,{unset:!0}))},hasChanged:function(n){return n==null?!i.isEmpty(this.changed):i.has(this.changed,n)},changedAttributes:function(n){var u,t,f,r;if(!n)return this.hasChanged()?i.clone(this.changed):!1;t=!1,f=this._changing?this._previousAttributes:this._attributes;for(r in n)i.isEqual(f[r],u=n[r])||((t||(t={}))[r]=u);return t},previous:function(n){return n==null||!this._previousAttributes?null:this._previousAttributes[n]},previousAttributes:function(){return i.clone(this._previousAttributes)},fetch:function(n){n=n?i.clone(n):{},n.parse===void 0&&(n.parse=!0);var t=this,r=n.success;return n.success=function(i){if(!t.set(t.parse(i,n),n))return!1;r&&r(t,i,n),collection.trigger(new u.ConboEvent(u.ConboEvent.SYNC,{model:t,response:i,options:n}))},e(this,n),this.sync("read",this,n)},save:function(n,t,r){var u,o,c,s=this._attributes,f,h;return(n==null||typeof n=="object"?(u=n,r=t):(u={})[n]=t,u&&(!r||!r.wait)&&!this.set(u,r))?!1:(r=i.extend({validate:!0},r),!this._validate(u,r))?!1:(u&&r.wait&&(this._attributes=i.extend({},s,u)),r.parse===void 0&&(r.parse=!0),f=this,h=r.success,r.success=function(n){f._attributes=s;var t=f.parse(n,r);if(r.wait&&(t=i.extend(u||{},t)),i.isObject(t)&&!f.set(t,r))return!1;h&&h(f,n,r),f.trigger("sync",f,n,r)},e(this,r),o=this.isNew()?"create":r.patch?"patch":"update",o==="patch"&&(r.attrs=u),c=this.sync(o,this,r),u&&r.wait&&(this._attributes=s),c)},destroy:function(n){var o;n=n?i.clone(n):{};var t=this,r=n.success,f=function(){this.trigger(new u.ConboEvent(u.ConboEvent.DESTROY,{model:this,collection:t.collection,options:n}))};return(n.success=function(i){(n.wait||t.isNew())&&f(),r&&r(t,i,n),t.isNew()||t.trigger("sync",t,i,n)},this.isNew())?(n.success(),!1):(e(this,n),o=this.sync("delete",this,n),n.wait||f(),o)},url:function(){var n=i.result(this,"urlRoot")||i.result(this.collection,"url")||urlError();return this.isNew()?n:n+(n.charAt(n.length-1)==="/"?"":"/")+encodeURIComponent(this.id)},parse:function(n){return n},clone:function(){return new this.constructor(this._attributes)},isNew:function(){return this.id==null},isValid:function(n){return this._validate({},i.extend(n||{},{validate:!0}))},toString:function(){return"[conbo.Model]"},_validate:function(n,t){if(!t.validate||!this.validate)return!0;n=i.extend({},this._attributes,n);var r=this.validationError=this.validate(n,t)||null;return r?(this.trigger(new u.ConboEvent(u.ConboEvent.INVALID,{model:this,error:r,options:i.extend(t||{},{validationError:r})})),!1):!0}}),e=function(n,t){var i=t.error;t.error=function(r){!i||i(n,r,t),n.trigger(new u.ConboEvent("error",{model:n,response:r,options:t}))}},u.Collection=u.EventDispatcher.extend({model:u.Model,constructor:function(n,t){t||(t={}),t.url&&(this.url=t.url),t.model&&(this.model=t.model),t.comparator!==void 0&&(this.comparator=t.comparator),this._reset(),this._inject(t),n&&this.reset(n,i.extend({silent:!0},t)),this.initialize.apply(this,arguments)},initialize:function(){},toJSON:function(n){return this.map(function(t){return t.toJSON(n)})},sync:function(){return u.sync.apply(this,arguments)},add:function(n,t){return this.set(n,i.defaults(t||{},{add:!0,merge:!1,remove:!1}))},remove:function(n,t){n=i.isArray(n)?n.slice():[n],t||(t={});for(var e,r,f=0,o=n.length;f<o;f++)(r=this.get(n[f]),r)&&(delete this._byId[r.id],delete this._byId[r.cid],e=this.indexOf(r),this.models.splice(e,1),this.length--,t.silent||(t.index=e,this.trigger(new u.ConboEvent(u.ConboEvent.REMOVE,{model:r,collection:this,options:t}))),this._removeReference(r));return this},set:function(n,t){t=i.defaults(t||{},{add:!0,remove:!0,merge:!0}),t.parse&&(n=this.parse(n,t)),i.isArray(n)||(n=n?[n]:[]);for(var r,s,o=!1,h=t.at,l=this.comparator&&h==null&&t.sort!==!1,v=i.isString(this.comparator)?this.comparator:null,f=[],c=[],a={},u=0,e=n.length;u<e;u++)if(r=this._prepareModel(n[u],t))if(s=this.get(r))t.remove&&(a[s.cid]=!0),t.merge&&(s.set(r.attributes,t),l&&!o&&s.hasChanged(v)&&(o=!0));else if(t.add){f.push(r);r.on("all",this._onModelEvent,this);this._byId[r.cid]=r,r.id!=null&&(this._byId[r.id]=r)}if(t.remove){for(u=0,e=this.length;u<e;++u)a[(r=this.models[u]).cid]||c.push(r);c.length&&this.remove(c,t)}if(f.length&&(l&&(o=!0),this.length+=f.length,h!=null?[].splice.apply(this.models,[h,0].concat(f)):[].push.apply(this.models,f)),o&&this.sort({silent:!0}),t.silent)return this;for(u=0,e=f.length;u<e;u++)(r=f[u]).trigger("add",r,this,t);return o&&this.trigger("sort",this,t),this},reset:function(n,t){t||(t={});for(var r=0,f=this.models.length;r<f;r++)this._removeReference(this.models[r]);return t.previousModels=this.models,this._reset(),this.add(n,i.extend({silent:!0},t)),t.silent||this.trigger(new u.ConboEvent(u.ConboEvent.RESET,{collection:this,options:t})),this},push:function(n,t){return n=this._prepareModel(n,t),this.add(n,i.extend({at:this.length},t)),n},pop:function(n){var t=this.at(this.length-1);return this.remove(t,n),t},unshift:function(n,t){return n=this._prepareModel(n,t),this.add(n,i.extend({at:0},t)),n},shift:function(n){var t=this.at(0);return this.remove(t,n),t},slice:function(n,t){return this.models.slice(n,t)},get:function(n){if(n!=null)return this._idAttr||(this._idAttr=this.model.prototype.idAttribute),this._byId[n.id||n.cid||n[this._idAttr]||n]},at:function(n){return this.models[n]},where:function(n,t){return i.isEmpty(n)?t?void 0:[]:this[t?"find":"filter"](function(t){for(var i in n)if(n[i]!==t.get(i))return!1;return!0})},findWhere:function(n){return this.where(n,!0)},sort:function(n){if(!this.comparator)throw new Error("Cannot sort a set without a comparator");return n||(n={}),i.isString(this.comparator)||this.comparator.length===1?this.models=this.sortBy(this.comparator,this):this.models.sort(i.bind(this.comparator,this)),n.silent||this.trigger(new u.ConboEvent(u.ConboEvent.SORT,{collection:this,options:n})),this},sortedIndex:function(n,t,r){t||(t=this.comparator);var u=i.isFunction(t)?t:function(n){return n.get(t)};return i.sortedIndex(this.models,n,u,r)},pluck:function(n){return i.invoke(this.models,"get",n)},fetch:function(n){n=n?i.clone(n):{},n.parse===void 0&&(n.parse=!0);var r=n.success,t=this;return n.success=function(i){var f=n.reset?"reset":"set";t[f](i,n),r&&r(t,i,n),t.trigger(new u.ConboEvent(u.ConboEvent.SYNC,{collection:t,response:i,options:n}))},e(this,n),this.sync("read",this,n)},create:function(n,t){if(t=t?i.clone(t):{},!(n=this._prepareModel(n,t)))return!1;t.wait||this.add(n,t);var u=this,r=t.success;return t.success=function(i){t.wait&&u.add(n,t),r&&r(n,i,t)},n.save(null,t),n},parse:function(n){return n},_reset:function(){this.length=0,this.models=[],this._byId={}},_prepareModel:function(n,t){if(n instanceof u.Model)return n.collection||(n.collection=this),n;t||(t={}),t.collection=this;var i=new this.model(n,t);return i._validate(n,t)?i:(this.trigger(new u.ConboEvent(u.ConboEvent.INVALID,{collection:this,attrs:n,options:t})),!1)},_removeReference:function(n){this===n.collection&&delete n.collection,n.off("all",this._onModelEvent,this)},_onModelEvent:function(n){(n.type!=u.ConboEvent.ADD&&n.type!=u.ConboEvent.REMOVE||n.collection==this)&&(n.type==u.ConboEvent.DESTROY&&this.remove(n.model,n.options),n.model&&n.type=="change:"+n.model.idAttribute&&(delete this._byId[n.model.previous(n.model.idAttribute)],model.id!=null&&(this._byId[model.id]=model)),this.trigger(n))},toString:function(){return"[conbo.Collection]"}}),l=["forEach","each","map","collect","reduce","foldl","inject","reduceRight","foldr","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","toArray","size","first","head","take","initial","rest","tail","drop","last","without","indexOf","shuffle","lastIndexOf","isEmpty","chain"],i.each(l,function(n){u.Collection.prototype[n]=function(){var t=[].slice.call(arguments);return t.unshift(this.models),i[n].apply(i,t)}}),a=["groupBy","countBy","sortBy"],i.each(a,function(n){u.Collection.prototype[n]=function(t,r){var u=i.isFunction(t)?t:function(n){return n.get(t)};return i[n](this.models,u,r)}});var v=/^[#\/]|\s+$/g,w=/^\/+|\/+$/g,b=/msie [\w.]+/,k=/\/$/;u.History=u.EventDispatcher.extend({started:!1,interval:50,constructor:function(t){this.handlers=[],this.bindAll("checkUrl"),typeof n!="undefined"&&(this.location=n.location,this.history=n.history),this._inject(t),this.initialize.apply(this,arguments)},initialize:function(){},getHash:function(n){var t=(n||this).location.href.match(/#(.*)$/);return t?t[1]:""},getFragment:function(n,t){if(n==null)if(this._hasPushState||!this._wantsHashChange||t){n=this.location.pathname;var i=this.root.replace(k,"");n.indexOf(i)||(n=n.substr(i.length))}else n=this.getHash();return n.replace(v,"")},start:function(t){var r,f;if(this.started)throw new Error("conbo.history has already been started");this.started=!0,this.options=i.extend({},{root:"/"},this.options,t),this.root=this.options.root,this._wantsHashChange=this.options.hashChange!==!1,this._wantsPushState=!!this.options.pushState,this._hasPushState=!!(this.options.pushState&&this.history&&this.history.pushState);var e=this.getFragment(),o=document.documentMode,s=b.exec(navigator.userAgent.toLowerCase())&&(!o||o<=7);if(this.root=("/"+this.root+"/").replace(w,"/"),s&&this._wantsHashChange&&(this.iframe=u.$('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,this.navigate(e)),this._hasPushState)u.$(n).on("popstate",this.checkUrl);else if(this._wantsHashChange&&"onhashchange"in n&&!s)u.$(n).on("hashchange",this.checkUrl);else this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval));return(this.fragment=e,r=this.location,f=r.pathname.replace(/[^\/]$/,"$&/")===this.root,this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!f)?(this.fragment=this.getFragment(null,!0),this.location.replace(this.root+this.location.search+"#"+this.fragment),!0):(this._wantsPushState&&this._hasPushState&&f&&r.hash&&(this.fragment=this.getHash().replace(v,""),this.history.replaceState({},document.title,this.root+this.fragment+r.search)),this.options.silent?void 0:this.loadUrl())},stop:function(){u.$(n).off("popstate",this.checkUrl).off("hashchange",this.checkUrl),clearInterval(this._checkUrlInterval),this.started=!1},route:function(n,t){this.handlers.unshift({route:n,callback:t})},checkUrl:function(){var n=this.getFragment();if(n===this.fragment&&this.iframe&&(n=this.getFragment(this.getHash(this.iframe))),n===this.fragment)return!1;this.iframe&&this.navigate(n),this.loadUrl()||this.loadUrl(this.getHash())},loadUrl:function(n){var t=this.fragment=this.getFragment(n);return i.any(this.handlers,function(n){if(n.route.test(t))return n.callback(t),!0})},navigate:function(n,t){if(!this.started)return!1;if(t&&t!==!0||(t={trigger:t}),n=this.getFragment(n||""),this.fragment!==n){this.fragment=n;var i=this.root+n;if(this._hasPushState)this.history[t.replace?"replaceState":"pushState"]({},document.title,i);else if(this._wantsHashChange)this._updateHash(this.location,n,t.replace),this.iframe&&n!==this.getFragment(this.getHash(this.iframe))&&(t.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,n,t.replace));else return this.location.assign(i);t.trigger&&this.loadUrl(n)}},_updateHash:function(n,t,i){if(i){var r=n.href.replace(/(javascript:|#).*$/,"");n.replace(r+"#/"+t)}else n.hash="#/"+t}}),u.history=new u.History;var d=/\((.*?)\)/g,g=/(\(\?)?:\w+/g,nt=/\*\w+/g,tt=/[\-{}\[\]+?.,\\\^$|#\s]/g;return u.Router=u.EventDispatcher.extend({constructor:function(n){n||(n={}),n.routes&&(this.routes=n.routes),this._bindRoutes(),this._inject(n),this.initialize.apply(this,arguments)},initialize:function(){},route:function(n,t,r){return i.isRegExp(n)||(n=this._routeToRegExp(n)),r||(r=this[t]),i.isFunction(t)&&(r=t,t=""),r||(r=this[t]),u.history.route(n,this.bind(function(i){var o=this._extractParameters(n,i),f,e;r&&r.apply(this,o),f={router:this,route:n,name:t,parameters:o},this.trigger(new u.ConboEvent("route:"+t,f)),e=new u.ConboEvent(u.ConboEvent.ROUTE,f),this.trigger(e),u.history.trigger(e)})),this},navigate:function(n,t){return u.history.navigate(n,t),this},toString:function(){return"[conbo.Router]"},_bindRoutes:function(){if(this.routes){this.routes=i.result(this,"routes");for(var n,t=i.keys(this.routes);(n=t.pop())!=null;)this.route(n,this.routes[n])}},_routeToRegExp:function(n){return n=n.replace(tt,"\\$&").replace(d,"(?:$1)?").replace(g,function(n,t){return t?n:"([^/]+)"}).replace(nt,"(.*?)"),new RegExp("^"+n+"$")},_extractParameters:function(n,t){var r=n.exec(t).slice(1);return i.map(r,function(n){return n?decodeURIComponent(n):null})}}),u.sync=function(t,r,f){var o=y[t],e,s,h;return i.defaults(f||(f={}),{emulateHTTP:u.emulateHTTP,emulateJSON:u.emulateJSON}),e={type:o,dataType:f.dataType||r.dataType||"json"},f.url||(e.url=i.result(r,"url")||urlError()),f.data==null&&r&&(t==="create"||t==="update"||t==="patch")&&(e.contentType="application/json",e.data=JSON.stringify(f.attrs||r.toJSON(f))),f.emulateJSON&&(e.contentType="application/x-www-form-urlencoded",e.data=e.data?{model:e.data}:{}),f.emulateHTTP&&(o==="PUT"||o==="DELETE"||o==="PATCH")&&(e.type="POST",f.emulateJSON&&(e.data._method=o),s=f.beforeSend,f.beforeSend=function(n){return n.setRequestHeader("X-HTTP-Method-Override",o),s?s.apply(this,arguments):void 0}),e.type==="GET"||f.emulateJSON||(e.processData=!1),e.dataType!="json"&&(e.contentType=f.contentType||r.dataType||"application/json",e.processData=!1),e.type!=="PATCH"||!n.ActiveXObject||n.external&&n.external.msActiveXFilteringEnabled||(e.xhr=function(){return new ActiveXObject("Microsoft.XMLHTTP")}),h=f.xhr=u.ajax(i.extend(e,f)),r.trigger("request",r,h,f),h},y={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"},u.ajax=function(){return u.$.ajax.apply(u.$,arguments)},u},r,u;if(typeof module!="undefined"&&module.exports){try{r=require("underscore")}catch(e){try{r=require("lodash")}catch(e){throw new Error("Conbo.js requires underscore or lodash");}}try{u=require("jQuery")}catch(e){try{u=require("jquery")}catch(e){}}module.exports=i(r,u)}else typeof define=="function"&&define.amd?define("conbo",["underscore","jquery"],function(n,t){return i(n,t)}):n.conbo=i(n._,n.jQuery||n.Zepto||n.ender)})(this)