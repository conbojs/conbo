(function(n,t){function i(){
/*! 
 * Conbo.js: Lightweight MVC application framework for JavaScript
 * http://conbojs.mesmotronic.com/
 * 
 * Copyright (c) 2013 Mesmotronic Limited
 * Released under the MIT license
 * http://www.mesmotronic.com/legal/mit
 */
var r={},o=typeof require=="function",i=r._=o?require("underscore"):n._,e,h,c,l,u,a,v,w;try{e=r.$=o?require("jquery"):n.jQuery||n.Zepto||n.ender}catch(rt){}r.VERSION="1.0.11",r.toString=function(){return"[Conbo "+this.VERSION+"]"},r.Class=function(n){i.isObject(n)&&!!n.context&&this._inject(n),this.initialize.apply(this,arguments)},r.Class.prototype={initialize:function(){},callLater:function(n){return i.defer(this.bind.apply(this,[n].concat(i.rest(arguments)))),this},callSuper:function(n){return this._super[n]?this._super[n].apply(this,i.rest(arguments)):t},defineProperty:function(n,i,r,u){if(!("defineProperty"in Object))throw"Object.defineProperty is not supported by the current browser";return i=i||function(){return this["_"+n]},r=r||function(t){this["_"+n]=t},Object.defineProperty(this,n,{enumerable:!0,configurable:!0,get:i,set:r}),u!==t&&(this[n]=u),this},defineAccessor:function(n,i,r,u){return i=i||function(){return this["_"+n]},r=r||function(t){return this["_"+n]=t,this},this[n]=function(){return(arguments.length?r:i).apply(this,arguments)},u!==t&&this[n](u),this},bind:function(n){return i.bind.apply(i,[n,this].concat(i.rest(arguments)))},bindAll:function(){return i.bindAll.apply(i,[this].concat(i.toArray(arguments))),this},_inject:function(n){return this.options=i.defaults(n||{},this.options),this.context=this.context||(this.options.context?this.options.context:new r.Context(n)),this.context.injectSingletons(this),this}},r.Class.extend=function(n,t){var r,u=this,f;return r=n&&i.has(n,"constructor")?n.constructor:function(){return u.apply(this,arguments)},i.extend(r,u,t),f=function(){this.constructor=r},f.prototype=u.prototype,r.prototype=new f,n&&i.extend(r.prototype,n),r.prototype._super=u.prototype,r},Array.prototype.indexOf||(Array.prototype.indexOf=function(n,t){return i.indexOf(this,obj,t)}),Array.prototype.forEach||(Array.prototype.forEach=function(n,t){i.each(this,n,t)}),String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),r.Event=r.Class.extend({currentTarget:t,target:t,type:t,constructor:function(n){i.isString(n)?this.type=n:i.defaults(this,n),this.initialize.apply(this,arguments)},initialize:function(){},clone:function(){return i.clone(this)},preventDefault:function(){this.defaultPrevented=!0},stopPropagation:function(){this.cancelBubble=!0},stopImmediatePropagation:function(){this.immediatePropagationStopped=!0,this.stopPropagation()},toString:function(){return"[conbo.Event]"}},{ALL:"all",all:function(n){var r=[],t;for(t in this)i.isString(this[t])&&this[t]!=this.ALL&&r.push(this[t]);return n?r:r.join(" ")}}),r.ConboEvent=r.Event.extend({toString:function(){return"[conbo.ConboEvent]"}},{ERROR:"error",INVALID:"invalid",CHANGE:"change",ADD:"add",REMOVE:"remove",DESTROY:"destroy",RESET:"reset",SORT:"sort",REQUEST:"request",SYNC:"sync",ROUTE:"route",ALL:"all"}),r.EventDispatcher=r.Class.extend({trigger:function(n){var u,f,e,t,o;if(!n)throw"Event undefined";if((i.isString(n)&&(n=new r.Event(n)),n instanceof r.Event||(n=i.defaults(new r.Event,n)),!this._queue||!(n.type in this._queue)&&!this._queue.all)||(n.target||(n.target=this),n.currentTarget=this,u=i.union(this._queue[n.type]||[],this._queue.all||[]),!u||!u.length))return this;for(f=0,e=u.length;f<e;++f)if(t=u[f],o=t.handler.call(t.scope||this,n),t.once&&this._off(n.type,t.handler,t.scope),o===!1||n.immediatePropagationStopped)break;return this},on:function(n,t,r,u){if(!n)throw"Event type undefined";if(!t)throw"Event handler undefined";return i.isString(n)&&(n=n.split(" ")),i.isArray(n)?i.each(n,function(n){this._on(n,t,r,u,!1)},this):i.each(n,function(n,t){this._on(t,n,r,u,!1)},this),this},one:function(n,t,r,u){if(!n)throw"Event type undefined";if(!t)throw"Event handler undefined";return i.isString(n)&&(n=n.split(" ")),i.isArray(n)?i.each(n,function(n){this._on(n,t,r,u,!0)},this):i.each(n,function(n,t){this._on(t,n,r,u,!0)},this),this},off:function(n,t){if(!arguments.length)return this._queue={},this;if(!n)throw"Event type undefined";if(arguments.length==2&&!t)return this;var r=arguments;return i.isString(n)&&(n=n.split(" ")),i.isArray(n)?i.each(n,function(){this._off.apply(this,r)},this):i.each(n,function(){this._off.apply(this,r)},this),this},toString:function(){return"[conbo.EventDispatcher]"},addEventListener:function(){this.on.apply(this,arguments)},removeEventListener:function(){this.off.apply(this,arguments)},_on:function(n,t,i,r,u){n=="*"&&(n="all"),this._queue||(this._queue={}),this._off(n,t,i),n in this._queue||(this._queue[n]=[]),this._queue[n].push({handler:t,scope:i,once:u,priority:r||0}),this._queue[n].sort(function(n,t){return t.priority-n.priority})},_off:function(n,t,i){var u,r;if(!this._queue||!(n in this._queue))return this;if(u=this._queue[n],arguments.length==1)return delete this._queue[n],this;for(r=0;r<u.length;r++)u[r].handler!=t&&u[r].handler||u[r].scope!=i&&u[r].scope||u.splice(r--,1);return this}}),r.Bindable=r.EventDispatcher.extend({get:function(n){var r=this._attributes();return(n in r)?i.isFunction(r[n])?this[n]():r[n]:t},set:function(n,t,u){var f=this._attributes(),e,o;if(i.isObject(n))return i.each(n,function(n,t){this.set(t,n,u)},this),this;if(e=!1,u||(u={silent:!1}),u.unset?(e=i.has(f,n),delete f[n]):i.isFunction(f[n])&&f[n]()!=t?(f[n](t),e=!0):f[n]!=t&&(f[n]=t,e=!0),e&&!u.silent){o={type:"change:"+n,attribute:n,value:t,options:u};try{this.trigger(new r.ConboEvent(o)),this.trigger(new r.ConboEvent(i.extend(o,{type:r.ConboEvent.CHANGE})))}catch(s){}}return this},unset:function(n,r){return r=i.defaults({unset:!0},r),this.set(n,t,r)},toString:function(){return"[conbo.Bindable]"},_attributes:function(){return this}}),r.Context=r.EventDispatcher.extend({constructor:function(n){this._commands={},this._singletons={},this.options=n||{},this.view=this.options.view;this.on(r.Event.ALL,this._allHandler);return this.initialize.apply(this,arguments),this},initialize:function(){},mapCommand:function(n,t){if(!n)throw"eventType cannot be undefined";if(!t)throw"commandClass cannot be undefined";if(!this._mapMulti(n,t,this.mapCommand))return this._commands[n]&&this._commands[n].indexOf(t)!=-1?void 0:(this._commands[n]=this._commands[n]||[],this._commands[n].push(t),this)},unmapCommand:function(n,i){if(!n)throw"eventType cannot be undefined";if(!this._mapMulti(n,i,this.unmapCommand)){if(i===t){delete this._commands[n];return}if(this._commands[n]){var r=this._commands[n].indexOf(i);if(r!=-1)return this._commands[n].splice(r,1),this}}},mapSingleton:function(n,t){if(!n)throw"propertyName cannot be undefined";if(!t)throw"singletonClass cannot be undefined";if(!this._mapMulti(n,t,this.mapSingleton))return this._singletons[n]=i.isFunction(t)?new t(arguments[2],arguments[3],arguments[4]):t,this},unmapSingleton:function(n){if(!n)throw"propertyName cannot be undefined";if(!this._mapMulti(n,null,this.unmapSingleton))return this._singletons[n]?(delete this._singletons[n],this):void 0},addTo:function(n){return i.extend(n||{},{context:this})},injectSingletons:function(n){for(var i in n)n[i]===t&&(n[i]=this._singletons[i]);return this},toString:function(){return"[conbo.Context]"},_allHandler:function(n){var t=i.union(this._commands.all||[],this._commands[n.type]||[]);t.length&&i.each(t,function(t){this._executeCommand(t,n)},this)},_executeCommand:function(n,t){var i,r;return r={event:t},i=new n(this.addTo(r)),i.execute(),i=null,this},_mapMulti:function(n,t,r){if(i.isArray(n)||n.indexOf(" ")==-1)return!1;var u=i.isArray(n)?n:n.split(" ");return i.each(u,function(n){r(n,t)},this),!0}}),r.Map=r.Bindable.extend({constructor:function(n){i.isObject(n)&&!!n.context&&this._inject(n),this.initialize.apply(this,arguments),i.defaults(this._attributes(),this.defaults)},toJSON:function(){return i.clone(this._attributes())},toString:function(){return"[conbo.Map]"}}),r.BindingUtils=r.Class.extend({},{bindElement:function(n,t,i,r){return r=r||function(n){return typeof n=="undefined"?"":String(n)},e(i).each(function(i,u){var f=e(u),o=f[0].tagName,s;switch(o){case"INPUT":case"SELECT":case"TEXTAREA":s=(f.attr("type")||o).toLowerCase();switch(s){case"checkbox":f.prop("checked",Boolean(n.get(t)));n.on("change:"+t,function(n){f.prop("checked",Boolean(n.value))});f.on("input change",function(){n.set(t,f.is(":checked"))});return;case"radio":f.val()==n.get(t)&&f.prop("checked",!0);n.on("change:"+t,function(n){f.val()==n.value&&f.prop("checked",!0)});break;default:f.val(n.get(t));n.on("change:"+t,function(n){f.val()!=n.value&&f.val(n.value)})}f.on("input change",function(){n.set(t,f.val()||f.html())});break;default:f.html(r(n.get(t)));n.on("change:"+t,function(n){var t=r(n.value);f.html(t)})}}),this},bindProperty:function(n,t,i,u,f){u=u||t;n.on("change:"+t,function(n){r.EventDispatcher.prototype.set.call(i,u,n.value)});return f&&this.bindProperty(i,u,n,t),this},bindSetter:function(n,t,i){n.on("change:"+t,function(n){i(n.value)});return this}}),h=/^(\S+)\s*(.*)$/,c=["model","collection","el","id","attributes","className","tagName","events"],r.View=r.Bindable.extend({constructor:function(n){this.cid=i.uniqueId("view"),this._addStyle(),this._configure(n||{}),this._ensureElement(),this._inject(n),this.initialize.apply(this,arguments),this.delegateEvents()},tagName:"div",$:function(n){return this.$el.find(n)},initialize:function(){},render:function(){return this},remove:function(){return this.$el.remove(),this.unbindView().off(),this},setElement:function(n,t){return this.$el&&this.undelegateEvents().unbindView(),this.$el=n instanceof r.$?n:r.$(n),this.el=this.$el[0],t!==!1&&this.delegateEvents(),this instanceof r.Application||this.bindView(),this},appendView:function(n){if(arguments.length>1)return i.each(arguments,function(n){this.appendView(n)},this),this;if(!(n instanceof r.View))throw"Parameter must be instance of conbo.View class";return this.$el.append(n.el),this},prependView:function(n){if(arguments.length>1)return i.each(arguments,function(n){this.prependView(n)},this),this;if(!(n instanceof r.View))throw"Parameter must be instance of conbo.View class";return this.$el.prepend(n.el),this},mouseEnabled:function(){return this._setClass.apply(this,i.union(["conbo-disabled"],i.toArray(arguments)))},visible:function(){return this._setClass.apply(this,i.union(["conbo-invisible"],i.toArray(arguments)))},includeInLayout:function(){return this._setClass.apply(this,i.union(["conbo-excludeFromLayout"],i.toArray(arguments)))},bindView:function(){return this.$("[data-property]").each(this.bind(function(n,i){var u=this.$(i).data(),e;if(p=u.property,s=u.source,f=typeof this[u.parse]=="function"?this[u.parse]:t,!!s&&!(s in this))throw new Error("Unable to bind element to undefined source: "+s);e=!s?this:this[s],r.BindingUtils.bindElement(e,p,i,f)})),this},unbindView:function(){return this},loadCSS:function(t){if("document"in n){var i;return i=document.createElement("link"),i.type="text/css",i.rel="stylesheet",i.href=t,document.getElementsByTagName("head")[0].appendChild(i),this}},delegateEvents:function(n){var r,t;if(n||(n=i.result(this,"events"))){this.undelegateEvents();for(r in n){if(t=n[r],i.isFunction(t)||(t=this[n[r]]),!t)throw new Error('Method "'+n[r]+'" does not exist');var f=r.match(h),u=f[1],e=f[2];if(t=i.bind(t,this),u+=".delegateEvents"+this.cid,e==="")this.$el.on(u,t);else this.$el.on(u,e,t)}return this}},undelegateEvents:function(){return this.$el.off(".delegateEvents"+this.cid),this},toString:function(){return"[conbo.View]"},_addStyle:function(){if(!!r.style)return this;var n=r.$('<style type="text/css">.conbo-invisible { visibility:hidden !important; }.conbo-excludeFromLayout { display:none !important; }.conbo-disabled { pointer-events:none !important; }<\/style>');return r.$("head").append(n),r.style=n,this},_configure:function(n){this.options&&(n=i.extend({},i.result(this,"options"),n)),i.extend(this,i.pick(n,c)),this.options=n},_ensureElement:function(){var n,t;this.el?(this.setElement(i.result(this,"el"),!1),this.className&&this.$el.addClass(this.className)):(n=i.extend({},i.result(this,"attributes")),this.id&&(n.id=i.result(this,"id")),this.className&&(n["class"]=i.result(this,"className")),t=r.$("<"+i.result(this,"tagName")+">").attr(n),this.setElement(t,!1))},_setClass:function(n,t){var u=i.rest(arguments),f,e;return u.length?(f=i.isString(t)||i.isElement(t)||t instanceof r.$,e=f?this.$(t):this.$el,u.length==1&&f)?!e.hasClass(n):(u.length==2&&f&&(t=u[1]),e.removeClass(n),t||e.addClass(n),this):!this.$el.hasClass(n)}}),r.Actor=r.Bindable.extend({constructor:function(n){this._inject(n),this.initialize.apply(this,arguments)}}),r.Application=r.View.extend({contextClass:r.Context,constructor:function(n){n=n||{},n.view=n.view||this,this.context=n.context||new this.contextClass(n),r.View.prototype.constructor.apply(this,arguments)},toString:function(){return"[conbo.Application]"}}),r.Command=r.EventDispatcher.extend({constructor:function(n){this._inject(n),this.event=this.options.event||{},this.initialize.apply(this,arguments)},initialize:function(){},execute:function(){},toString:function(){return"[conbo.Command]"}}),r.ServerApplication=r.Bindable.extend({contextClass:r.Context,constructor:function(n){n=n||{},n.view=n.view||this,this.context=n.context||new this.contextClass(n),this._inject(n),this.options=n,this.initialize.apply(this,arguments)},initialize:function(){},toString:function(){return"[conbo.ServerApplication]"}}),r.Model=r.Bindable.extend({constructor:function(n,t){var u,r=n||{};t||(t={}),this.cid=i.uniqueId("c"),this.attributes={},i.extend(this,i.pick(t,["url","urlRoot","collection"])),t.parse&&(r=this.parse(r,t)||{}),(u=i.result(this,"defaults"))&&(r=i.defaults({},r,u)),this.set(r,t),this._inject(t),this.initialize.apply(this,arguments)},changed:null,validationError:null,idAttribute:"id",initialize:function(){},toJSON:function(){return i.clone(this.attributes)},sync:function(){return r.sync.apply(this,arguments)},get:function(n){return this.attributes[n]},escape:function(n){return i.escape(this.get(n))},has:function(n){return this.get(n)!=null},set:function(n,t,u){var f,e,a,o,c,l,v,h,s,y;if(n==null)return this;if(typeof n=="object"?(e=n,u=t):(e={})[n]=t,u||(u={}),!this._validate(e,u))return!1;a=u.unset,c=u.silent,o=[],l=this._changing,this._changing=!0,l||(this._previousAttributes=i.clone(this.attributes),this.changed={}),h=this.attributes,v=this._previousAttributes,this.idAttribute in e&&(this.id=e[this.idAttribute]);for(f in e)t=e[f],i.isEqual(h[f],t)||o.push(f),i.isEqual(v[f],t)?delete this.changed[f]:this.changed[f]=t,a?delete h[f]:h[f]=t;if(!c)for(o.length&&(this._pending=!0),s=0,y=o.length;s<y;s++)this.trigger(new r.ConboEvent({type:"change:"+o[s],model:this,value:h[o[s]],options:u,attribute:o[s]}));if(l)return this;if(!c)while(this._pending)this._pending=!1,this.trigger(new r.ConboEvent({type:r.ConboEvent.CHANGE,model:this,options:u}));return this._pending=!1,this._changing=!1,this},unset:function(n,t){return this.set(n,void 0,i.extend({},t,{unset:!0}))},clear:function(n){var t={},r;for(r in this.attributes)t[r]=void 0;return this.set(t,i.extend({},n,{unset:!0}))},hasChanged:function(n){return n==null?!i.isEmpty(this.changed):i.has(this.changed,n)},changedAttributes:function(n){var u,t,f,r;if(!n)return this.hasChanged()?i.clone(this.changed):!1;t=!1,f=this._changing?this._previousAttributes:this.attributes;for(r in n)i.isEqual(f[r],u=n[r])||((t||(t={}))[r]=u);return t},previous:function(n){return n==null||!this._previousAttributes?null:this._previousAttributes[n]},previousAttributes:function(){return i.clone(this._previousAttributes)},fetch:function(n){n=n?i.clone(n):{},n.parse===void 0&&(n.parse=!0);var t=this,f=n.success;return n.success=function(i){if(!t.set(t.parse(i,n),n))return!1;f&&f(t,i,n),collection.trigger(new r.ConboEvent({type:r.ConboEvent.SYNC,model:t,response:i,options:n}))},u(this,n),this.sync("read",this,n)},save:function(n,t,r){var f,o,c,s=this.attributes,e,h;return(n==null||typeof n=="object"?(f=n,r=t):(f={})[n]=t,f&&(!r||!r.wait)&&!this.set(f,r))?!1:(r=i.extend({validate:!0},r),!this._validate(f,r))?!1:(f&&r.wait&&(this.attributes=i.extend({},s,f)),r.parse===void 0&&(r.parse=!0),e=this,h=r.success,r.success=function(n){e.attributes=s;var t=e.parse(n,r);if(r.wait&&(t=i.extend(f||{},t)),i.isObject(t)&&!e.set(t,r))return!1;h&&h(e,n,r),e.trigger("sync",e,n,r)},u(this,r),o=this.isNew()?"create":r.patch?"patch":"update",o==="patch"&&(r.attrs=f),c=this.sync(o,this,r),f&&r.wait&&(this.attributes=s),c)},destroy:function(n){var o;n=n?i.clone(n):{};var t=this,f=n.success,e=function(){this.trigger(new r.ConboEvent({type:r.ConboEvent.DESTROY,model:this,collection:t.collection,options:n}))};return(n.success=function(i){(n.wait||t.isNew())&&e(),f&&f(t,i,n),t.isNew()||t.trigger("sync",t,i,n)},this.isNew())?(n.success(),!1):(u(this,n),o=this.sync("delete",this,n),n.wait||e(),o)},url:function(){var n=i.result(this,"urlRoot")||i.result(this.collection,"url")||urlError();return this.isNew()?n:n+(n.charAt(n.length-1)==="/"?"":"/")+encodeURIComponent(this.id)},parse:function(n){return n},clone:function(){return new this.constructor(this.attributes)},isNew:function(){return this.id==null},isValid:function(n){return this._validate({},i.extend(n||{},{validate:!0}))},_validate:function(n,t){if(!t.validate||!this.validate)return!0;n=i.extend({},this.attributes,n);var u=this.validationError=this.validate(n,t)||null;return u?(this.trigger(new r.ConboEvent({type:r.ConboEvent.INVALID,model:this,error:u,options:i.extend(t||{},{validationError:u})})),!1):!0},_attributes:function(){return this.attributes}}),l=["keys","values","pairs","invert","pick","omit"],i.each(l,function(n){r.Model.prototype[n]=function(){var t=[].slice.call(arguments);return t.unshift(this.attributes),i[n].apply(i,t)}}),u=function(n,t){var i=t.error;t.error=function(r){i&&i(n,r,t),n.trigger("error",n,r,t)}},r.Collection=r.EventDispatcher.extend({model:r.Model,constructor:function(n,t){t||(t={}),t.url&&(this.url=t.url),t.model&&(this.model=t.model),t.comparator!==void 0&&(this.comparator=t.comparator),this._reset(),this._inject(t),this.initialize.apply(this,arguments),n&&this.reset(n,i.extend({silent:!0},t))},initialize:function(){},toJSON:function(n){return this.map(function(t){return t.toJSON(n)})},sync:function(){return r.sync.apply(this,arguments)},add:function(n,t){return this.set(n,i.defaults(t||{},{add:!0,merge:!1,remove:!1}))},remove:function(n,t){n=i.isArray(n)?n.slice():[n],t||(t={});for(var e,u,f=0,o=n.length;f<o;f++)(u=this.get(n[f]),u)&&(delete this._byId[u.id],delete this._byId[u.cid],e=this.indexOf(u),this.models.splice(e,1),this.length--,t.silent||(t.index=e,this.trigger(new r.ConboEvent({type:r.ConboEvent.REMOVE,model:u,collection:this,options:t}))),this._removeReference(u));return this},set:function(n,t){t=i.defaults(t||{},{add:!0,remove:!0,merge:!0}),t.parse&&(n=this.parse(n,t)),i.isArray(n)||(n=n?[n]:[]);for(var r,s,o=!1,h=t.at,l=this.comparator&&h==null&&t.sort!==!1,v=i.isString(this.comparator)?this.comparator:null,f=[],c=[],a={},u=0,e=n.length;u<e;u++)if(r=this._prepareModel(n[u],t))if(s=this.get(r))t.remove&&(a[s.cid]=!0),t.merge&&(s.set(r.attributes,t),l&&!o&&s.hasChanged(v)&&(o=!0));else if(t.add){f.push(r);r.on("all",this._onModelEvent,this);this._byId[r.cid]=r,r.id!=null&&(this._byId[r.id]=r)}if(t.remove){for(u=0,e=this.length;u<e;++u)a[(r=this.models[u]).cid]||c.push(r);c.length&&this.remove(c,t)}if(f.length&&(l&&(o=!0),this.length+=f.length,h!=null?[].splice.apply(this.models,[h,0].concat(f)):[].push.apply(this.models,f)),o&&this.sort({silent:!0}),t.silent)return this;for(u=0,e=f.length;u<e;u++)(r=f[u]).trigger("add",r,this,t);return o&&this.trigger("sort",this,t),this},reset:function(n,t){t||(t={});for(var u=0,f=this.models.length;u<f;u++)this._removeReference(this.models[u]);return t.previousModels=this.models,this._reset(),this.add(n,i.extend({silent:!0},t)),t.silent||this.trigger(new r.ConboEvent({type:r.ConboEvent.RESET,collection:this,options:t})),this},push:function(n,t){return n=this._prepareModel(n,t),this.add(n,i.extend({at:this.length},t)),n},pop:function(n){var t=this.at(this.length-1);return this.remove(t,n),t},unshift:function(n,t){return n=this._prepareModel(n,t),this.add(n,i.extend({at:0},t)),n},shift:function(n){var t=this.at(0);return this.remove(t,n),t},slice:function(n,t){return this.models.slice(n,t)},get:function(n){if(n!=null)return this._idAttr||(this._idAttr=this.model.prototype.idAttribute),this._byId[n.id||n.cid||n[this._idAttr]||n]},at:function(n){return this.models[n]},where:function(n,t){return i.isEmpty(n)?t?void 0:[]:this[t?"find":"filter"](function(t){for(var i in n)if(n[i]!==t.get(i))return!1;return!0})},findWhere:function(n){return this.where(n,!0)},sort:function(n){if(!this.comparator)throw new Error("Cannot sort a set without a comparator");return n||(n={}),i.isString(this.comparator)||this.comparator.length===1?this.models=this.sortBy(this.comparator,this):this.models.sort(i.bind(this.comparator,this)),n.silent||this.trigger(new r.ConboEvent({type:r.ConboEvent.SORT,collection:this,options:n})),this},sortedIndex:function(n,t,r){t||(t=this.comparator);var u=i.isFunction(t)?t:function(n){return n.get(t)};return i.sortedIndex(this.models,n,u,r)},pluck:function(n){return i.invoke(this.models,"get",n)},fetch:function(n){n=n?i.clone(n):{},n.parse===void 0&&(n.parse=!0);var f=n.success,t=this;return n.success=function(i){var u=n.reset?"reset":"set";t[u](i,n),f&&f(t,i,n),t.trigger(new r.ConboEvent({type:r.ConboEvent.SYNC,collection:t,response:i,options:n}))},u(this,n),this.sync("read",this,n)},create:function(n,t){if(t=t?i.clone(t):{},!(n=this._prepareModel(n,t)))return!1;t.wait||this.add(n,t);var u=this,r=t.success;return t.success=function(i){t.wait&&u.add(n,t),r&&r(n,i,t)},n.save(null,t),n},parse:function(n){return n},_reset:function(){this.length=0,this.models=[],this._byId={}},_prepareModel:function(n,t){if(n instanceof r.Model)return n.collection||(n.collection=this),n;t||(t={}),t.collection=this;var i=new this.model(n,t);return i._validate(n,t)?i:(this.trigger(new r.ConboEvent({type:r.ConboEvent.INVALID,collection:this,attrs:n,options:t})),!1)},_removeReference:function(n){this===n.collection&&delete n.collection,n.off("all",this._onModelEvent,this)},_onModelEvent:function(n){(n.type!=r.ConboEvent.ADD&&n.type!=r.ConboEvent.REMOVE||n.collection==this)&&(n.type==r.ConboEvent.DESTROY&&this.remove(n.model,n.options),n.model&&n.type=="change:"+n.model.idAttribute&&(delete this._byId[n.model.previous(n.model.idAttribute)],model.id!=null&&(this._byId[model.id]=model)),this.trigger(n))},toString:function(){return"[conbo.Collection]"}}),a=["forEach","each","map","collect","reduce","foldl","inject","reduceRight","foldr","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","toArray","size","first","head","take","initial","rest","tail","drop","last","without","indexOf","shuffle","lastIndexOf","isEmpty","chain"],i.each(a,function(n){r.Collection.prototype[n]=function(){var t=[].slice.call(arguments);return t.unshift(this.models),i[n].apply(i,t)}}),v=["groupBy","countBy","sortBy"],i.each(v,function(n){r.Collection.prototype[n]=function(t,r){var u=i.isFunction(t)?t:function(n){return n.get(t)};return i[n](this.models,u,r)}});var y=/^[#\/]|\s+$/g,b=/^\/+|\/+$/g,k=/msie [\w.]+/,d=/\/$/;r.History=r.EventDispatcher.extend({started:!1,interval:50,constructor:function(){this.handlers=[],i.bindAll(this,"checkUrl"),typeof n!="undefined"&&(this.location=n.location,this.history=n.history)},getHash:function(n){var t=(n||this).location.href.match(/#(.*)$/);return t?t[1]:""},getFragment:function(n,t){if(n==null)if(this._hasPushState||!this._wantsHashChange||t){n=this.location.pathname;var i=this.root.replace(d,"");n.indexOf(i)||(n=n.substr(i.length))}else n=this.getHash();return n.replace(y,"")},start:function(t){var u,f;if(this.started)throw new Error("conbo.history has already been started");this.started=!0,this.options=i.extend({},{root:"/"},this.options,t),this.root=this.options.root,this._wantsHashChange=this.options.hashChange!==!1,this._wantsPushState=!!this.options.pushState,this._hasPushState=!!(this.options.pushState&&this.history&&this.history.pushState);var e=this.getFragment(),o=document.documentMode,s=k.exec(navigator.userAgent.toLowerCase())&&(!o||o<=7);if(this.root=("/"+this.root+"/").replace(b,"/"),s&&this._wantsHashChange&&(this.iframe=r.$('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,this.navigate(e)),this._hasPushState)r.$(n).on("popstate",this.checkUrl);else if(this._wantsHashChange&&"onhashchange"in n&&!s)r.$(n).on("hashchange",this.checkUrl);else this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval));return(this.fragment=e,u=this.location,f=u.pathname.replace(/[^\/]$/,"$&/")===this.root,this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!f)?(this.fragment=this.getFragment(null,!0),this.location.replace(this.root+this.location.search+"#"+this.fragment),!0):(this._wantsPushState&&this._hasPushState&&f&&u.hash&&(this.fragment=this.getHash().replace(y,""),this.history.replaceState({},document.title,this.root+this.fragment+u.search)),this.options.silent?void 0:this.loadUrl())},stop:function(){r.$(n).off("popstate",this.checkUrl).off("hashchange",this.checkUrl),clearInterval(this._checkUrlInterval),this.started=!1},route:function(n,t){this.handlers.unshift({route:n,callback:t})},checkUrl:function(){var n=this.getFragment();if(n===this.fragment&&this.iframe&&(n=this.getFragment(this.getHash(this.iframe))),n===this.fragment)return!1;this.iframe&&this.navigate(n),this.loadUrl()||this.loadUrl(this.getHash())},loadUrl:function(n){var t=this.fragment=this.getFragment(n);return i.any(this.handlers,function(n){if(n.route.test(t))return n.callback(t),!0})},navigate:function(n,t){if(!this.started)return!1;if(t&&t!==!0||(t={trigger:t}),n=this.getFragment(n||""),this.fragment!==n){this.fragment=n;var i=this.root+n;if(this._hasPushState)this.history[t.replace?"replaceState":"pushState"]({},document.title,i);else if(this._wantsHashChange)this._updateHash(this.location,n,t.replace),this.iframe&&n!==this.getFragment(this.getHash(this.iframe))&&(t.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,n,t.replace));else return this.location.assign(i);t.trigger&&this.loadUrl(n)}},_updateHash:function(n,t,i){if(i){var r=n.href.replace(/(javascript:|#).*$/,"");n.replace(r+"#"+t)}else n.hash="#"+t}});var g=/\((.*?)\)/g,nt=/(\(\?)?:\w+/g,tt=/\*\w+/g,it=/[\-{}\[\]+?.,\\\^$|#\s]/g;return r.Router=r.EventDispatcher.extend({constructor:function(n){n||(n={}),n.routes&&(this.routes=n.routes),this._bindRoutes(),this.initialize.apply(this,arguments)},initialize:function(){},route:function(n,t,u){return i.isRegExp(n)||(n=this._routeToRegExp(n)),u||(u=this[t]),i.isRegExp(n)||(n=this._routeToRegExp(n)),i.isFunction(t)&&(u=t,t=""),u||(u=this[t]),r.history.route(n,this.bind(function(i){var e=this._extractParameters(n,i),f;u&&u.apply(this,e),this.trigger(new r.ConboEvent({type:"route:"+t,router:this,route:n,params:options})),f=new r.ConboEvent({type:r.ConboEvent.ROUTE,router:this,route:t,params:e}),this.trigger(f),r.history.trigger(f)})),this},navigate:function(n,t){return r.history.navigate(n,t),this},toString:function(){return"[conbo.Router]"},_bindRoutes:function(){if(this.routes){this.routes=i.result(this,"routes");for(var n,t=i.keys(this.routes);(n=t.pop())!=null;)this.route(n,this.routes[n])}},_routeToRegExp:function(n){return n=n.replace(it,"\\$&").replace(g,"(?:$1)?").replace(nt,function(n,t){return t?n:"([^/]+)"}).replace(tt,"(.*?)"),new RegExp("^"+n+"$")},_extractParameters:function(n,t){var r=n.exec(t).slice(1);return i.map(r,function(n){return n?decodeURIComponent(n):null})}}),r.sync=function(t,u,f){var o=w[t],e,s,h;return i.defaults(f||(f={}),{emulateHTTP:r.emulateHTTP,emulateJSON:r.emulateJSON}),e={type:o,dataType:f.dataType||u.dataType||"json"},f.url||(e.url=i.result(u,"url")||urlError()),f.data==null&&u&&(t==="create"||t==="update"||t==="patch")&&(e.contentType="application/json",e.data=JSON.stringify(f.attrs||u.toJSON(f))),f.emulateJSON&&(e.contentType="application/x-www-form-urlencoded",e.data=e.data?{model:e.data}:{}),f.emulateHTTP&&(o==="PUT"||o==="DELETE"||o==="PATCH")&&(e.type="POST",f.emulateJSON&&(e.data._method=o),s=f.beforeSend,f.beforeSend=function(n){return n.setRequestHeader("X-HTTP-Method-Override",o),s?s.apply(this,arguments):void 0}),e.type==="GET"||f.emulateJSON||(e.processData=!1),e.dataType!="json"&&(e.contentType=f.contentType||u.dataType||"application/json",e.processData=!1),e.type!=="PATCH"||!n.ActiveXObject||n.external&&n.external.msActiveXFilteringEnabled||(e.xhr=function(){return new ActiveXObject("Microsoft.XMLHTTP")}),h=f.xhr=r.ajax(i.extend(e,f)),u.trigger("request",u,h,f),h},w={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"},r.ajax=function(){return r.$.ajax.apply(r.$,arguments)},r}typeof module!="undefined"&&module.exports?module.exports=i():typeof define=="function"&&define.amd?define("conbo",["jquery","underscore"],function(){return i()}):n.conbo=i()})(this)