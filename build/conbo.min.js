!function(window,document,undefined){var create=function(_,$){var conbo={VERSION:"1.2.5",_:_,$:$,toString:function(){return"Conbo "+this.VERSION}};Array.prototype.indexOf||(Array.prototype.indexOf=function(a,b){return _.indexOf(this,a,b)}),Array.prototype.forEach||(Array.prototype.forEach=function(a,b){return _.each(this,a,b)}),String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),Object.prototype.hasOwnProperty||(Object.prototype.hasOwnProperty=function(a){return a in this});var _isFunction=_.isFunction;_.isClass=function(a){return a instanceof conbo.Class},_.isFunction=function(a){return _isFunction(a)&&!_.isClass(a)},$.fn.cbData=function(){for(var a={},b=this.get()[0].attributes,c=0,d=0;d<b.length;++d)if(0==b[d].name.indexOf("cb-")){var e=b[d].name.substr(3).replace(/-([a-z])/g,function(a){return a[1].toUpperCase()});a[e]=b[d].value,++c}return c?a:undefined},$.expr[":"].cbAttr=function(a,b,c){var d=$(a),e=(c[3]||"").split(","),f=d.cbData();return f?f&&!e.length?!0:e[0]&&!e[1]?e[0]in f:e[0]&&e[1]?f[e[0]]==e[1]:!1:!1},conbo.cssClassExists=function(a){for(var b=document.styleSheets,c=0;c<b.length;c++)for(var d=b[c].rules||document.styleSheets[c].cssRules,e=0;e<d.length;e++)if(d[e].selectorText==a)return!0;return!1},$(function(){conbo.cssClassExists(".cb-hide")||$("head").append($('<style type="text/css">.cb-hide { visibility:hidden !important; }.cb-exclude { display:none !important; }.cb-disable { pointer-events:none !important; cursor:default !important; }</style>'))}),conbo.Class=function(){this.initialize.apply(this,arguments)},conbo.Class.prototype={initialize:function(){},callLater:function(a){return _.defer(this.bind.apply(this,[a].concat(_.rest(arguments)))),this},callSuper:function(a){return this._super[a]?this._super[a].apply(this,_.rest(arguments)):undefined},defineProperty:function(a,b,c,d){if(!("defineProperty"in Object))throw new Error("Object.defineProperty is not supported by the current browser");return b=b||function(){return this["_"+a]},c=c||function(b){this["_"+a]=b},Object.defineProperty(this,a,{enumerable:!0,configurable:!0,get:b,set:c}),d!==undefined&&(this[a]=d),this},defineAccessor:function(a,b,c,d){return b=b||function(){return this["_"+a]},c=c||function(b){return this["_"+a]=b,this},this[a]=function(){return(arguments.length?c:b).apply(this,arguments)},d!==undefined&&this[a](d),this},bind:function(a){return _.bind.apply(_,[a,this].concat(_.rest(arguments)))},bindAll:function(){return _.bindAll.apply(_,[this].concat(_.toArray(arguments))),this},toString:function(){return"conbo.Class"}},conbo.Class.extend=function(a,b){var c,d=this;c=a&&_.has(a,"constructor")?a.constructor:function(){return d.apply(this,arguments)},_.extend(c,d,b);var e=function(){this.constructor=c};return e.prototype=d.prototype,c.prototype=new e,a&&_.extend(c.prototype,a),c.prototype._super=d.prototype,c},conbo.Injectable=conbo.Class.extend({constructor:function(a){this._inject(a),this.initialize.apply(this,arguments)},toString:function(){return"conbo.Injectable"},_inject:function(a){return a||(a={}),this.defineAccessor("context",undefined,undefined,_.result(this,"context")||a.context),this.context()&&this.context().injectSingletons(this),this}}),conbo.Event=conbo.Class.extend({constructor:function(a){if(_.isString(a)?this.type=a:_.defaults(this,a),!this.type)throw new Error("Invalid or undefined event type");this.initialize.apply(this,arguments)},initialize:function(){},clone:function(){return _.clone(this)},preventDefault:function(){this.defaultPrevented=!0},stopPropagation:function(){this.cancelBubble=!0},stopImmediatePropagation:function(){this.immediatePropagationStopped=!0,this.stopPropagation()},toString:function(){return"conbo.Event"}},{ALL:"all",all:function(a){var b=[];for(var c in this)_.isString(this[c])&&this[c]!=this.ALL&&b.push(this[c]);return a?b:b.join(" ")}}),conbo.ConboEvent=conbo.Event.extend({initialize:function(a,b){_.defaults(this,b)},toString:function(){return"conbo.ConboEvent"}},{ERROR:"error",INVALID:"invalid",CHANGE:"change",ADD:"add",REMOVE:"remove",DESTROY:"destroy",RESET:"reset",SORT:"sort",REQUEST:"request",SYNC:"sync",ROUTE:"route",ALL:"all"}),conbo.EventDispatcher=conbo.Injectable.extend({trigger:function(a){if(!a)throw new Error("Event undefined");if(!_.isString(a)&&a instanceof conbo.Event||(a=new conbo.Event(a)),!this._queue||!(a.type in this._queue)&&!this._queue.all)return this;a.target||(a.target=this),a.currentTarget=this;var b=_.union(this._queue[a.type]||[],this._queue.all||[]);if(!b||!b.length)return this;for(var c=0,d=b.length;d>c;++c){var e=b[c],f=e.handler.call(e.scope||this,a);if(e.once&&this._off(a.type,e.handler,e.scope),f===!1||a.immediatePropagationStopped)break}return this},on:function(a,b,c,d){if(!a)throw new Error("Event type undefined");if(!b||!_.isFunction(b))throw new Error("Event handler is undefined or not a function");return _.isString(a)&&(a=a.split(" ")),_.isArray(a)?_.each(a,function(a){this._on(a,b,c,d,!1)},this):_.each(a,function(a,b){this._on(b,a,c,d,!1)},this),this},one:function(a,b,c,d){if(!a)throw new Error("Event type undefined");if(!b||!_.isFunction(b))throw new Error("Event handler is undefined or not a function");return _.isString(a)&&(a=a.split(" ")),_.isArray(a)?_.each(a,function(a){this._on(a,b,c,d,!0)},this):_.each(a,function(a,b){this._on(b,a,c,d,!0)},this),this},off:function(a,b){if(!arguments.length)return this._queue={},this;if(!a)throw new Error("Event type undefined");if(2==arguments.length&&!b)return this;var c=arguments;return _.isString(a)&&(a=a.split(" ")),_.isArray(a)?_.each(a,function(){this._off.apply(this,c)},this):_.each(a,function(){this._off.apply(this,c)},this),this},toString:function(){return"conbo.EventDispatcher"},dispatchEvent:function(){this.trigger.apply(this,arguments)},addEventListener:function(){this.on.apply(this,arguments)},removeEventListener:function(){this.off.apply(this,arguments)},_on:function(a,b,c,d,e){"*"==a&&(a="all"),this._queue||(this._queue={}),this._off(a,b,c),a in this._queue||(this._queue[a]=[]),this._queue[a].push({handler:b,scope:c,once:e,priority:d||0}),this._queue[a].sort(function(a,b){return b.priority-a.priority})},_off:function(a,b,c){if(!(this._queue&&a in this._queue))return this;var d=this._queue[a];if(1==arguments.length)return delete this._queue[a],this;var e;for(e=0;e<d.length;e++)d[e].handler!=b&&d[e].handler||d[e].scope!=c&&d[e].scope||d.splice(e--,1);return this}}),conbo.Bindable=conbo.EventDispatcher.extend({get:function(a){var b=_.result(this,"_attributes");return _.result(b,a)},set:function(a,b,c){if(_.isObject(a))return _.each(a,function(a,b){this.set(b,a,c)},this),this;var d=_.result(this,"_attributes"),e=!1;if(c||(c={silent:!1}),c.unset?(e=a in d,delete d[a]):_.isFunction(d[a])?d[a]()!==b&&(d[a](b),e=!0):d[a]!=b&&(d[a]=b,e=!0),e&&!c.silent){var c={attribute:a,value:b,options:c};this.trigger(new conbo.ConboEvent("change:"+a,c)),this.trigger(new conbo.ConboEvent(conbo.ConboEvent.CHANGE,c))}return this},unset:function(a,b){return b=_.defaults({unset:!0},b),this.set(a,undefined,b)},toString:function(){return"conbo.Bindable"},_attributes:function(){return this}}),conbo.Context=conbo.EventDispatcher.extend({constructor:function(a){return a=a||{},this._commands={},this._singletons={},this.defineAccessor("app",undefined,undefined,a.app),this.on(conbo.Event.ALL,this._allHandler),this.initialize.apply(this,arguments),this},initialize:function(){},mapCommand:function(a,b){if(!a)throw new Error("eventType cannot be undefined");if(!b)throw new Error("commandClass cannot be undefined");if(!(this._mapMulti(a,b,this.mapCommand)||this._commands[a]&&-1!=this._commands[a].indexOf(b)))return this._commands[a]=this._commands[a]||[],this._commands[a].push(b),this},unmapCommand:function(a,b){if(!a)throw new Error("eventType cannot be undefined");if(!this._mapMulti(a,b,this.unmapCommand)){if(b===undefined)return void delete this._commands[a];if(this._commands[a]){var c=this._commands[a].indexOf(b);if(-1!=c)return this._commands[a].splice(c,1),this}}},mapSingleton:function(a,b){if(!a)throw new Error("propertyName cannot be undefined");if(!b)throw new Error("singletonClass cannot be undefined");if(!this._mapMulti(a,b,this.mapSingleton))return this._singletons[a]=_.isFunction(b)?new b(arguments[2],arguments[3],arguments[4]):b,this},unmapSingleton:function(a){if(!a)throw new Error("propertyName cannot be undefined");if(!this._mapMulti(a,null,this.unmapSingleton)&&this._singletons[a])return delete this._singletons[a],this},addTo:function(a){return _.extend(a||{},{context:this})},injectSingletons:function(a){for(var b in a)a[b]===undefined&&b in this._singletons&&(a[b]=this._singletons[b]);return this},toString:function(){return"conbo.Context"},_allHandler:function(a){var b=_.union(this._commands.all||[],this._commands[a.type]||[]);b.length&&_.each(b,function(b){this._executeCommand(b,a)},this)},_executeCommand:function(a,b){var c,d;return d={event:b},c=new a(this.addTo(d)),c.execute(),c=null,this},_mapMulti:function(a,b,c){if(_.isArray(a)||-1==a.indexOf(" "))return!1;var d=_.isArray(a)?a:a.split(" ");return _.each(d,function(a){c(a,b)},this),!0}}),conbo.Hash=conbo.Bindable.extend({constructor:function(a,b){this._inject(b),this._attributes=_.defaults({},a,_.result(this,"defaults")),this.initialize.apply(this,arguments)},toJSON:function(){return _.clone(this._attributes)},toString:function(){return"conbo.Hash"}});var hashMethods=["keys","values","pairs","invert","pick","omit","size"];_.each(hashMethods,function(a){a in _&&(conbo.Hash.prototype[a]=function(){return _[a].apply(_,[this._attributes].concat(_.rest(arguments)))})}),conbo.AttributeBindings=conbo.Class.extend({},{show:function(a,b){this.hide(!a,b)},hide:function(a,b){var c=$(b);a?c.addClass("cb-hide"):c.removeClass("cb-hide")},include:function(a,b){this.exclude(!a,b)},exclude:function(a,b){var c=$(b);a?c.addClass("cb-exclude"):c.removeClass("cb-exclude")},html:function(a,b){$(b).html(a)}}),conbo.BindingUtils=conbo.Class.extend({},{bindElement:function(a,b,c,d){if(!(a instanceof conbo.Bindable))throw new Error("Source is not Bindable");if(!c)throw new Error("element is undefined");return d=d||function(a){return"undefined"==typeof a?"":String(a)},$(c).each(function(c,e){var f=$(e),g=f[0].tagName;switch(g){case"INPUT":case"SELECT":case"TEXTAREA":var h=(f.attr("type")||g).toLowerCase();switch(h){case"checkbox":return f.prop("checked",!!a.get(b)),a.on("change:"+b,function(a){f.prop("checked",!!a.value)}),void f.on("input change",function(){a.set(b,f.is(":checked"))});case"radio":f.val()==a.get(b)&&f.prop("checked",!0),a.on("change:"+b,function(a){f.val()==a.value&&f.prop("checked",!0)});break;default:f.val(a.get(b)),a.on("change:"+b,function(a){f.val()!=a.value&&f.val(a.value)})}f.on("input change",function(){a.set(b,f.val()||f.html())});break;default:f.html(d(a.get(b))),a.on("change:"+b,function(a){var b=d(a.value);f.html(b)})}}),this},bindAttribute:function(a,b,c,d,e){if(this._isReservedAttribute(d))return this;if(!c)throw new Error("element is undefined");if("bind"==d||"model"==d)return this.bindElement(a,b,c,e),this;var f,g=!1,h=!1,i=d.replace(/([A-Z])/g," $1").toLowerCase().split(" ");switch(!0){case"attr"==i[0]:d=d.substr(4),h=d in c;break;default:g=d in conbo.AttributeBindings,h=!g&&d in c}switch(e=e||function(a){return a},!0){case g:if(!(a instanceof conbo.Bindable))throw new Error("Source is not Bindable");f=function(){conbo.AttributeBindings[d](e(a.get(b)),c)},a.on("change:"+b,f),f();break;case h:switch(!0){case 0==d.indexOf("on"):if(!_.isFunction(a[b]))throw new Error("DOM events can only be bound to functions");return $(c).on(d.substr(2),a[b]),this;default:if(!(a instanceof conbo.Bindable))throw new Error("Source is not Bindable");f=function(){var f;f=e(a.get(b)),f=_.isBoolean(c[d])?!!f:f,c[d]=f},a.on("change:"+b,f),f(),$(c).on("input change",function(){a.set(b,c[d])})}}return this},bindView:function(view){if(!view)throw new Error("view is undefined");var nestedViews=view.$(".cb-view, [cb-view]"),scope=this,bind=function(index,el){var cbData=$(el).cbData();if(cbData){var keys=_.keys(cbData);keys.forEach(function(key){var d=cbData[key],b=d.split("|"),s=scope.cleanPropertyName(b[0]).split("."),p=s.pop(),m,f;try{m=s.length?eval("view."+s.join(".")):view}catch(e){}try{f=b[1]?eval("view."+scope.cleanPropertyName(b[1])):undefined,f=_.isFunction(f)?f:undefined}catch(e){}if(!m)throw new Error(b[0]+" is not defined in this View");if(!p)throw new Error("Unable to bind to undefined property: "+p);scope.bindAttribute(m,p,el,key,f)})}};bind(-1,view.el),view.$("*").filter(function(){return!nestedViews.find(this).length}).each(bind)},bindProperty:function(a,b,c,d,e){if(!(a instanceof conbo.Bindable))throw new Error("Source is not Bindable");return d||(d=b),a.on("change:"+b,function(a){return c instanceof conbo.Bindable?void c.set(d,a.value):void(c[d]=a.value)}),e&&c instanceof conbo.Bindable&&this.bindProperty(c,d,a,b),this},bindSetter:function(a,b,c){if(!(a instanceof conbo.Bindable))throw new Error("Source is not Bindable");if(!_.isFunction(c)){if(!(c&&b in c))throw new Error("Invalid setter function");c=c[b]}return a.on("change:"+b,function(a){c(a.value)}),this},cleanPropertyName:function(a){return(a||"").replace(/[^\w\.]/g,"")},toString:function(){return"conbo.BindingUtils"},_reservedAttributes:["app","view"],_isReservedAttribute:function(a){-1!=this._reservedAttributes.indexOf(a)}});var viewOptions=["model","collection","el","id","attributes","className","tagName","events","template","templateUrl"];conbo.View=conbo.Bindable.extend({constructor:function(a){a=_.clone(a)||{},this.cid=_.uniqueId("view"),this._configure(a),this._ensureElement(),this._inject(a),this.initialize.apply(this,arguments);var b,c=_.result(this,"templateUrl");try{b=_.result(this,"template")}catch(d){}c?this.load(c):(b&&_.isString(b)&&this.html(b),this.render(),this.bindView(),this.delegateEvents())},tagName:"div",initialize:function(){},$:function(a){return this.$el.find(a)},render:function(){return this},remove:function(){return this.$el.remove(),this.unbindView().off(),this},setElement:function(a,b){var c=!!this.$el;return c&&this.undelegateEvents().unbindView(),this.$el=$(a),this.el=this.$el[0],b!==!1&&this.delegateEvents(),!c||this instanceof conbo.Application||this.bindView(),this},appendView:function(a){if(arguments.length>1)return _.each(arguments,function(a){this.appendView(a)},this),this;if(!(a instanceof conbo.View))throw new Error("Parameter must be instance of conbo.View class");return this.$el.append(a.el),this},prependView:function(a){if(arguments.length>1)return _.each(arguments,function(a){this.prependView(a)},this),this;if(!(a instanceof conbo.View))throw new Error("Parameter must be instance of conbo.View class");return this.$el.prepend(a.el),this},mouseEnabled:function(){return this._setClass.apply(this,_.union(["cb-disable"],_.toArray(arguments)))},visible:function(){return this._setClass.apply(this,_.union(["cb-hide"],_.toArray(arguments)))},includeInLayout:function(){return this._setClass.apply(this,_.union(["cb-exclude"],_.toArray(arguments)))},bindView:function(){return conbo.BindingUtils.bindView(this),this},unbindView:function(){return this},load:function(a,b,c){this.unbindView(),this.undelegateEvents();var d=this.bind(function(a){this.template=a,c&&c.apply(this,arguments),this.render(),this.bindView(),this.delegateEvents()});this.$el.load(a,b,d)},loadCSS:function(a,b){if(!("document"in window))return this;var c=$("<link>").attr({rel:"stylesheet",type:"text/css",href:a}),d=c[0],e="sheet"in d,f=e?"sheet":"styleSheet",g=e?"cssRules":"rules",h=setInterval(function(){try{d[f]&&d[f][g].length&&(clearInterval(h),clearTimeout(i),b(!0))}catch(a){}},10),i=setTimeout(function(){clearInterval(h),clearTimeout(i),c.remove(),b(!1)},15e3);return $("head").append(c),this},delegateEvents:function(a){if(a||(a=_.result(this,"events"))){this.undelegateEvents();for(var b in a){var c=a[b];if(_.isFunction(c)||(c=this[a[b]]),!c)throw new Error('Method "'+a[b]+'" does not exist');var d=b.match(/^(\S+)\s*(.*)$/),e=d[1],f=d[2];c=_.bind(c,this),e+=".delegateEvents"+this.cid,""===f?this.$el.on(e,c):this.$el.on(e,f,c)}return this}},undelegateEvents:function(){return this.$el.off(".delegateEvents"+this.cid),this},toString:function(){return"conbo.View"},_configure:function(a){this.options&&(a=_.extend({},_.result(this,"options"),a)),_.extend(this,_.pick(a,viewOptions)),this.options=a},_ensureElement:function(){if(this.el)this.setElement(_.result(this,"el"),!1),this.className&&this.$el.addClass(this.className);else{var a=_.extend({},_.result(this,"attributes"));this.id&&(a.id=_.result(this,"id")),this.className&&(a["class"]=_.result(this,"className"));var b=$("<"+_.result(this,"tagName")+">").attr(a);this.setElement(b,!1)}this.$el.addClass("cb-view")},_setClass:function(a,b){var c=_.rest(arguments);if(!c.length)return!this.$el.hasClass(a);var d=_.isString(b)||_.isElement(b)||b instanceof $,e=d?this.$(b):this.$el;return 1==c.length&&d?!e.hasClass(a):(2==c.length&&d&&(b=c[1]),e.removeClass(a),b||e.addClass(a),this)}});var viewMethods=["html"];_.each(viewMethods,function(a){conbo.View.prototype[a]=function(){return this.$el[a].apply(this.$el,arguments)}}),conbo.Application=conbo.View.extend({contextClass:conbo.Context,constructor:function(a){a=_.clone(a)||{},a.app=this,this.defineAccessor("context",undefined,undefined,new this.contextClass(a)),this.defineAccessor("prefix",undefined,undefined,a.prefix||this.prefix||""),this.defineAccessor("namespace",undefined,undefined,a.namespace),a.el||a.autoApply===!1||this.applyApp(),conbo.View.prototype.constructor.apply(this,arguments),a.autoApply!==!1&&this.applyViews()},applyApp:function(){var a;for(var b in this.namespace())if(this instanceof this.namespace()[b]){a=b;break}var c='[cb-app="'+this._addPrefix(a)+'"]',d=$(c)[0];return d&&(this.el=d),this},applyViews:function(){var selector=this.prefix()?'[cb-view^="'+this._addPrefix()+'"]':"[cb-view]";return this.$(selector).each(this.bind(function(index,el){var view=this.$(el).cbData().view.replace(this._addPrefix(),""),viewClass=this.namespace()?this.namespace()[view]:eval(view);_.isFunction(viewClass)&&new viewClass(this.context().addTo({el:el}))})),this},toString:function(){return"conbo.Application"},_addPrefix:function(a){return a=a||"",this.prefix()?this.prefix()+"."+a:a}}),conbo.Command=conbo.EventDispatcher.extend({constructor:function(a){this._inject(a),this.defineAccessor("event",undefined,undefined,a.event||{}),this.initialize.apply(this,arguments)},initialize:function(){},execute:function(){},toString:function(){return"conbo.Command"}}),conbo.ServerApplication=conbo.Bindable.extend({contextClass:conbo.Context,constructor:function(a){a=_.clone(a)||{},a.app=this,a.context||(a.context=new this.contextClass(a)),this._inject(a),this.options=a,this.initialize.apply(this,arguments)},initialize:function(){},toString:function(){return"conbo.ServerApplication"}}),conbo.Model=conbo.Hash.extend({constructor:function(a,b){var c=a||{};b||(b={}),this.cid=_.uniqueId("c"),this._attributes={},_.extend(this,_.pick(b,["url","urlRoot","collection"])),b.parse&&(c=this.parse(c,b)||{}),c=_.defaults({},c,_.result(this,"defaults")),this.set(c,b),this._inject(b),this.initialize.apply(this,arguments)},changed:null,validationError:null,idAttribute:"id",initialize:function(){},sync:function(){return conbo.sync.apply(this,arguments)},get:function(a){return this._attributes[a]},escape:function(a){return _.escape(this.get(a))},has:function(a){return null!=this.get(a)},set:function(a,b,c){var d,e,f,g,h,i,j,k;if(null==a)return this;if("object"==typeof a?(e=a,c=b):(e={})[a]=b,c||(c={}),!this._validate(e,c))return!1;f=c.unset,h=c.silent,g=[],i=this._changing,this._changing=!0,i||(this._previousAttributes=_.clone(this._attributes),this.changed={}),k=this._attributes,j=this._previousAttributes,this.idAttribute in e&&(this.id=e[this.idAttribute]);for(d in e)b=e[d],_.isEqual(k[d],b)||g.push(d),_.isEqual(j[d],b)?delete this.changed[d]:this.changed[d]=b,f?delete k[d]:k[d]=b;if(!h){g.length&&(this._pending=!0);for(var l=0,m=g.length;m>l;l++)this.trigger(new conbo.ConboEvent("change:"+g[l],{model:this,value:k[g[l]],options:c,attribute:g[l]}))}if(i)return this;if(!h)for(;this._pending;)this._pending=!1,this.trigger(new conbo.ConboEvent(conbo.ConboEvent.CHANGE,{model:this,options:c}));return this._pending=!1,this._changing=!1,this},unset:function(a,b){return this.set(a,undefined,_.extend({},b,{unset:!0}))},clear:function(a){var b={};for(var c in this._attributes)b[c]=undefined;return this.set(b,_.extend({},a,{unset:!0}))},hasChanged:function(a){return null==a?!_.isEmpty(this.changed):a in this.changed},changedAttributes:function(a){if(!a)return this.hasChanged()?_.clone(this.changed):!1;var b,c=!1,d=this._changing?this._previousAttributes:this._attributes;for(var e in a)_.isEqual(d[e],b=a[e])||((c||(c={}))[e]=b);return c},previous:function(a){return null!=a&&this._previousAttributes?this._previousAttributes[a]:null},previousAttributes:function(){return _.clone(this._previousAttributes)},fetch:function(a){a=a?_.clone(a):{},a.parse===undefined&&(a.parse=!0);var b=a.success;return a.success=this.bind(function(c){return this.set(this.parse(c,a),a)?(b&&b(this,c,a),void this.trigger(new conbo.ConboEvent(conbo.ConboEvent.SYNC,{model:this,response:c,options:a}))):!1}),wrapError(this,a),this.sync("read",this,a)},save:function(a,b,c){var d,e,f,g=this._attributes;if(null==a||"object"==typeof a?(d=a,c=b):(d={})[a]=b,!(!d||c&&c.wait||this.set(d,c)))return!1;if(c=_.extend({validate:!0},c),!this._validate(d,c))return!1;d&&c.wait&&(this._attributes=_.extend({},g,d)),c.parse===undefined&&(c.parse=!0);var h=this,i=c.success;return c.success=function(a){h._attributes=g;var b=h.parse(a,c);return c.wait&&(b=_.extend(d||{},b)),_.isObject(b)&&!h.set(b,c)?!1:(i&&i(h,a,c),void h.trigger(new conbo.ConboEvent(conbo.ConboEvent.SYNC,{model:h,response:a,options:c})))},wrapError(this,c),e=this.isNew()?"create":c.patch?"patch":"update","patch"===e&&(c.attrs=d),f=this.sync(e,this,c),d&&c.wait&&(this._attributes=g),f},destroy:function(a){a=a?_.clone(a):{};var b=this,c=a.success,d=this.bind(function(){this.trigger(new conbo.ConboEvent(conbo.ConboEvent.DESTROY,{model:this,collection:b.collection,options:a}))});if(a.success=function(e){(a.wait||b.isNew())&&d(),c&&c(b,e,a),b.isNew()||b.trigger(new conbo.ConboEvent(conbo.ConboEvent.SYNC,{model:b,response:e,options:a}))},this.isNew())return a.success(),!1;wrapError(this,a);var e=this.sync("delete",this,a);return a.wait||d(),e},url:function(){var a=_.result(this,"urlRoot")||_.result(this.collection,"url")||urlError();return this.isNew()?a:a+("/"===a.charAt(a.length-1)?"":"/")+encodeURIComponent(this.id)},parse:function(a){return a},clone:function(){return new this.constructor(this._attributes)},isNew:function(){return null==this.id},isValid:function(a){return this._validate({},_.extend(a||{},{validate:!0}))},toString:function(){return"conbo.Model"},_validate:function(a,b){if(!b.validate||!this.validate)return!0;a=_.extend({},this._attributes,a);var c=this.validationError=this.validate(a,b)||null;return c?(this.trigger(new conbo.ConboEvent(conbo.ConboEvent.INVALID,{model:this,error:c,options:_.extend(b||{},{validationError:c})})),!1):!0}});var wrapError=function(a,b){var c=b.error;b.error=function(d){c&&c(a,d,b),a.trigger(new conbo.ConboEvent(conbo.ConboEvent.ERROR,{model:a,response:d,options:b}))}};conbo.Collection=conbo.EventDispatcher.extend({model:conbo.Model,constructor:function(a,b){b||(b={}),b.url&&(this.url=b.url),b.model&&(this.model=b.model),b.comparator!==undefined&&(this.comparator=b.comparator),this._reset(),this._inject(b),a&&this.reset(a,_.extend({silent:!0},b)),this.initialize.apply(this,arguments)},initialize:function(){},toJSON:function(a){return this.map(function(b){return b.toJSON(a)})},sync:function(){return conbo.sync.apply(this,arguments)},add:function(a,b){return this.set(a,_.defaults(b||{},{add:!0,merge:!1,remove:!1}))},remove:function(a,b){a=_.isArray(a)?a.slice():[a],b||(b={});var c,d,e,f;for(c=0,d=a.length;d>c;c++)f=this.get(a[c]),f&&(delete this._byId[f.id],delete this._byId[f.cid],e=this.indexOf(f),this.models.splice(e,1),this.length--,b.silent||(b.index=e,this.trigger(new conbo.ConboEvent(conbo.ConboEvent.REMOVE,{model:f,collection:this,options:b}))),this._removeReference(f));return this},set:function(a,b){b=_.defaults(b||{},{add:!0,remove:!0,merge:!0}),b.parse&&(a=this.parse(a,b)),_.isArray(a)||(a=a?[a]:[]);var c,d,e,f,g=!1,h=b.at,i=this.comparator&&null==h&&b.sort!==!1,j=_.isString(this.comparator)?this.comparator:null,k=[],l=[],m={};for(c=0,d=a.length;d>c;c++)(e=this._prepareModel(a[c],b))&&((f=this.get(e))?(b.remove&&(m[f.cid]=!0),b.merge&&(f.set(e.attributes,b),i&&!g&&f.hasChanged(j)&&(g=!0))):b.add&&(k.push(e),e.on("all",this._onModelEvent,this),this._byId[e.cid]=e,null!=e.id&&(this._byId[e.id]=e)));if(b.remove){for(c=0,d=this.length;d>c;++c)m[(e=this.models[c]).cid]||l.push(e);l.length&&this.remove(l,b)}if(k.length&&(i&&(g=!0),this.length+=k.length,null!=h?[].splice.apply(this.models,[h,0].concat(k)):[].push.apply(this.models,k)),g&&this.sort({silent:!0}),b.silent)return this;for(c=0,d=k.length;d>c;c++){var e=k[c];e.trigger(new conbo.ConboEvent(conbo.ConboEvent.ADD,{model:e,collection:this,options:b}))}return g&&this.trigger(new conbo.ConboEvent(conbo.ConboEvent.SORT,{collection:this,options:b})),this},reset:function(a,b){b||(b={});for(var c=0,d=this.models.length;d>c;c++)this._removeReference(this.models[c]);return b.previousModels=this.models,this._reset(),this.add(a,_.extend({silent:!0},b)),b.silent||this.trigger(new conbo.ConboEvent(conbo.ConboEvent.RESET,{collection:this,options:b})),this},push:function(a,b){return a=this._prepareModel(a,b),this.add(a,_.extend({at:this.length},b)),a},pop:function(a){var b=this.at(this.length-1);return this.remove(b,a),b},unshift:function(a,b){return a=this._prepareModel(a,b),this.add(a,_.extend({at:0},b)),a},shift:function(a){var b=this.at(0);return this.remove(b,a),b},slice:function(a,b){return this.models.slice(a,b)},get:function(a){return null==a?undefined:(this._idAttr||(this._idAttr=this.model.prototype.idAttribute),this._byId[a.id||a.cid||a[this._idAttr]||a])},at:function(a){return this.models[a]},where:function(a,b){return _.isEmpty(a)?b?undefined:[]:this[b?"find":"filter"](function(b){for(var c in a)if(a[c]!==b.get(c))return!1;return!0})},findWhere:function(a){return this.where(a,!0)},sort:function(a){if(!this.comparator)throw new Error("Cannot sort a set without a comparator");return a||(a={}),_.isString(this.comparator)||1===this.comparator.length?this.models=this.sortBy(this.comparator,this):this.models.sort(_.bind(this.comparator,this)),a.silent||this.trigger(new conbo.ConboEvent(conbo.ConboEvent.SORT,{collection:this,options:a})),this},sortedIndex:function(a,b,c){b||(b=this.comparator);var d=_.isFunction(b)?b:function(a){return a.get(b)};return _.sortedIndex(this.models,a,d,c)},pluck:function(a){return _.invoke(this.models,"get",a)},fetch:function(a){a=a?_.clone(a):{},a.parse===undefined&&(a.parse=!0);var b=a.success,c=this;return a.success=function(d){var e=a.reset?"reset":"set";c[e](d,a),b&&b(c,d,a),c.trigger(new conbo.ConboEvent(conbo.ConboEvent.SYNC,{collection:c,response:d,options:a}))},wrapError(this,a),this.sync("read",this,a)},create:function(a,b){if(b=b?_.clone(b):{},!(a=this._prepareModel(a,b)))return!1;b.wait||this.add(a,b);var c=this,d=b.success;return b.success=function(e){b.wait&&c.add(a,b),d&&d(a,e,b)},a.save(null,b),a},parse:function(a){return a},clone:function(){return new this.constructor(this.models)},_reset:function(){this.length=0,this.models=[],this._byId={}},_prepareModel:function(a,b){if(a instanceof conbo.Model)return a.collection||(a.collection=this),a;b||(b={}),b.collection=this;var c=new this.model(a,b);return c._validate(a,b)?c:(this.trigger(new conbo.ConboEvent(conbo.ConboEvent.INVALID,{collection:this,attrs:a,options:b})),!1)},_removeReference:function(a){this===a.collection&&delete a.collection,a.off("all",this._onModelEvent,this)},_onModelEvent:function(a){if(a.type!=conbo.ConboEvent.ADD&&a.type!=conbo.ConboEvent.REMOVE||a.collection==this){var b=a.model;a.type==conbo.ConboEvent.DESTROY&&this.remove(b,a.options),b&&a.type=="change:"+b.idAttribute&&(delete this._byId[a.model.previous(b.idAttribute)],null!=b.id&&(this._byId[b.id]=b)),this.trigger(a)}},toString:function(){return"conbo.Collection"}});var methods=["forEach","each","map","collect","reduce","foldl","inject","reduceRight","foldr","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","toArray","size","first","head","take","initial","rest","tail","drop","last","without","indexOf","shuffle","lastIndexOf","isEmpty","chain"];_.each(methods,function(a){a in _&&(conbo.Collection.prototype[a]=function(){var b=[].slice.call(arguments);return b.unshift(this.models),_[a].apply(_,b)})});var attributeMethods=["groupBy","countBy","sortBy"];_.each(attributeMethods,function(a){a in _&&(conbo.Collection.prototype[a]=function(b,c){var d=_.isFunction(b)?b:function(a){return a.get(b)};return _[a](this.models,d,c)})});var routeStripper=/^[#\/]|\s+$/g,rootStripper=/^\/+|\/+$/g,isExplorer=/msie [\w.]+/,trailingSlash=/\/$/;conbo.History=conbo.EventDispatcher.extend({started:!1,interval:50,constructor:function(a){this.handlers=[],this.bindAll("checkUrl"),"undefined"!=typeof window&&(this.location=window.location,this.history=window.history),this._inject(a),this.initialize.apply(this,arguments)},initialize:function(){},getHash:function(a){var b=(a||this).location.href.match(/#(.*)$/);return b?b[1]:""},getFragment:function(a,b){if(null==a)if(this._hasPushState||!this._wantsHashChange||b){a=this.location.pathname;var c=this.root.replace(trailingSlash,"");a.indexOf(c)||(a=a.substr(c.length))}else a=this.getHash();return a.replace(routeStripper,"")},start:function(a){if(this.started)throw new Error("conbo.history has already been started");this.started=!0,this.options=_.extend({},{root:"/"},this.options,a),this.root=this.options.root,this._wantsHashChange=this.options.hashChange!==!1,this._wantsPushState=!!this.options.pushState,this._hasPushState=!!(this.options.pushState&&this.history&&this.history.pushState);var b=this.getFragment(),c=document.documentMode,d=isExplorer.exec(navigator.userAgent.toLowerCase())&&(!c||7>=c);this.root=("/"+this.root+"/").replace(rootStripper,"/"),d&&this._wantsHashChange&&(this.iframe=$('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,this.navigate(b)),this._hasPushState?$(window).on("popstate",this.checkUrl):this._wantsHashChange&&"onhashchange"in window&&!d?$(window).on("hashchange",this.checkUrl):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),this.fragment=b;var e=this.location,f=e.pathname.replace(/[^\/]$/,"$&/")===this.root;return this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!f?(this.fragment=this.getFragment(null,!0),this.location.replace(this.root+this.location.search+"#"+this.fragment),!0):(this._wantsPushState&&this._hasPushState&&f&&e.hash&&(this.fragment=this.getHash().replace(routeStripper,""),this.history.replaceState({},document.title,this.root+this.fragment+e.search)),this.options.silent?void 0:this.loadUrl())},stop:function(){$(window).off("popstate",this.checkUrl).off("hashchange",this.checkUrl),clearInterval(this._checkUrlInterval),this.started=!1},route:function(a,b){this.handlers.unshift({route:a,callback:b})},checkUrl:function(){var a=this.getFragment();return a===this.fragment&&this.iframe&&(a=this.getFragment(this.getHash(this.iframe))),a===this.fragment?!1:(this.iframe&&this.navigate(a),void(this.loadUrl()||this.loadUrl(this.getHash())))},loadUrl:function(a){var b=this.fragment=this.getFragment(a),c=_.any(this.handlers,function(a){return a.route.test(b)?(a.callback(b),!0):void 0});return c},navigate:function(a,b){if(!this.started)return!1;
if(b&&b!==!0||(b={trigger:b}),a=this.getFragment(a||""),this.fragment!==a){this.fragment=a;var c=this.root+a;if(this._hasPushState)this.history[b.replace?"replaceState":"pushState"]({},document.title,c);else{if(!this._wantsHashChange)return this.location.assign(c);this._updateHash(this.location,a,b.replace),this.iframe&&a!==this.getFragment(this.getHash(this.iframe))&&(b.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,a,b.replace))}b.trigger&&this.loadUrl(a)}},toString:function(){return"conbo.History"},_updateHash:function(a,b,c){if(c){var d=a.href.replace(/(javascript:|#).*$/,"");a.replace(d+"#/"+b)}else a.hash="#/"+b}}),conbo.history=new conbo.History;var optionalParam=/\((.*?)\)/g,namedParam=/(\(\?)?:\w+/g,splatParam=/\*\w+/g,escapeRegExp=/[\-{}\[\]+?.,\\\^$|#\s]/g;conbo.Router=conbo.EventDispatcher.extend({constructor:function(a){a||(a={}),a.routes&&(this.routes=a.routes),this._bindRoutes(),this._inject(a),this.initialize.apply(this,arguments)},initialize:function(){},route:function(a,b,c){return _.isRegExp(a)||(a=this._routeToRegExp(a)),c||(c=this[b]),_.isFunction(b)&&(c=b,b=""),c||(c=this[b]),conbo.history.route(a,this.bind(function(d){var e=this._extractParameters(a,d);c&&c.apply(this,e);var f={router:this,route:a,name:b,parameters:e};this.trigger(new conbo.ConboEvent("route:"+b,f)),this.trigger(new conbo.ConboEvent(conbo.ConboEvent.ROUTE,f)),conbo.history.trigger(new conbo.ConboEvent(conbo.ConboEvent.ROUTE,f))})),this},navigate:function(a,b){return conbo.history.navigate(a,b),this},toString:function(){return"conbo.Router"},_bindRoutes:function(){if(this.routes){this.routes=_.result(this,"routes");for(var a,b=_.keys(this.routes);null!=(a=b.pop());)this.route(a,this.routes[a])}},_routeToRegExp:function(a){return a=a.replace(escapeRegExp,"\\$&").replace(optionalParam,"(?:$1)?").replace(namedParam,function(a,b){return b?a:"([^/]+)"}).replace(splatParam,"(.*?)"),new RegExp("^"+a+"$")},_extractParameters:function(a,b){var c=a.exec(b).slice(1);return _.map(c,function(a){return a?decodeURIComponent(a):null})}}),conbo.sync=function(a,b,c){var d=methodMap[a];_.defaults(c||(c={}),{emulateHTTP:conbo.emulateHTTP,emulateJSON:conbo.emulateJSON});var e={type:d,dataType:c.dataType||b.dataType||"json"};if(!c.url){var f=_.result(b,"url");if(!f)throw new Error('"url" must be specified');e.url=f}if(null!=c.data||!b||"create"!==a&&"update"!==a&&"patch"!==a||(e.contentType="application/json",e.data=JSON.stringify(c.attrs||b.toJSON(c))),c.emulateJSON&&(e.contentType="application/x-www-form-urlencoded",e.data=e.data?{model:e.data}:{}),c.emulateHTTP&&("PUT"===d||"DELETE"===d||"PATCH"===d)){e.type="POST",c.emulateJSON&&(e.data._method=d);var g=c.beforeSend;c.beforeSend=function(a){return a.setRequestHeader("X-HTTP-Method-Override",d),g?g.apply(this,arguments):void 0}}"GET"===e.type||c.emulateJSON||(e.processData=!1),"json"!=e.dataType&&(e.contentType=c.contentType||b.dataType||"application/json",e.processData=!1),"PATCH"!==e.type||!window.ActiveXObject||window.external&&window.external.msActiveXFilteringEnabled||(e.xhr=function(){return new ActiveXObject("Microsoft.XMLHTTP")});var h=c.xhr=conbo.ajax(_.extend(e,c));return b.trigger(new conbo.ConboEvent(conbo.ConboEvent.REQUEST,{model:b,xhr:h,options:c})),h};var methodMap={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"};return conbo.ajax=function(){return $.ajax.apply($,arguments)},conbo};if("undefined"!=typeof module&&module.exports){var _,$;try{_=require("lodash")}catch(e){try{_=require("underscore")}catch(e){throw new Error("Conbo.js requires underscore or lodash")}}try{$=require("jQuery")}catch(e){try{$=require("jquery")}catch(e){}}module.exports=create(_,$)}else"function"==typeof define&&define.amd?define("conbo",["underscore","jquery"],function(a,b){return create(a,b)}):window.conbo=create(window._,window.jQuery||window.Zepto||window.ender)}(this,document);