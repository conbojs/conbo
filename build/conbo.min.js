!function(a,b){var c=function(c,d){var e={VERSION:"1.1.3",_:c,$:d,toString:function(){return"[Conbo "+this.VERSION+"]"}};e.Class=function(a){this._inject(a),this.initialize.apply(this,arguments)},e.Class.prototype={initialize:function(){},callLater:function(a){return c.defer(this.bind.apply(this,[a].concat(c.rest(arguments)))),this},callSuper:function(a){return this._super[a]?this._super[a].apply(this,c.rest(arguments)):b},defineProperty:function(a,c,d,e){if(!("defineProperty"in Object))throw new Error("Object.defineProperty is not supported by the current browser");return c=c||function(){return this["_"+a]},d=d||function(b){this["_"+a]=b},Object.defineProperty(this,a,{enumerable:!0,configurable:!0,get:c,set:d}),e!==b&&(this[a]=e),this},defineAccessor:function(a,c,d,e){return c=c||function(){return this["_"+a]},d=d||function(b){return this["_"+a]=b,this},this[a]=function(){return(arguments.length?d:c).apply(this,arguments)},e!==b&&this[a](e),this},bind:function(a){return c.bind.apply(c,[a,this].concat(c.rest(arguments)))},bindAll:function(){return c.bindAll.apply(c,[this].concat(c.toArray(arguments))),this},toString:function(){return"conbo.Class"},_inject:function(a){return this.options=c.defaults(a||{},this.options),this.context||(this.context=this.options.context),this.context&&this.context.injectSingletons(this),this}},e.Class.extend=function(a,b){var d,e=this;d=a&&c.has(a,"constructor")?a.constructor:function(){return e.apply(this,arguments)},c.extend(d,e,b);var f=function(){this.constructor=d};return f.prototype=e.prototype,d.prototype=new f,a&&c.extend(d.prototype,a),d.prototype._super=e.prototype,d},Array.prototype.indexOf||(Array.prototype.indexOf=function(a,b){return c.indexOf(this,a,b)}),Array.prototype.forEach||(Array.prototype.forEach=function(a,b){c.each(this,a,b)}),String.prototype.trim||(String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}),e.Event=e.Class.extend({constructor:function(a){if(c.isString(a)?this.type=a:c.defaults(this,a),!this.type)throw new Error("Invalid or undefined event type");this.initialize.apply(this,arguments)},initialize:function(){},clone:function(){return c.clone(this)},preventDefault:function(){this.defaultPrevented=!0},stopPropagation:function(){this.cancelBubble=!0},stopImmediatePropagation:function(){this.immediatePropagationStopped=!0,this.stopPropagation()},toString:function(){return"conbo.Event"}},{ALL:"all",all:function(a){var b=[];for(var d in this)c.isString(this[d])&&this[d]!=this.ALL&&b.push(this[d]);return a?b:b.join(" ")}}),e.ConboEvent=e.Event.extend({initialize:function(a,b){c.defaults(this,b)},toString:function(){return"conbo.ConboEvent"}},{ERROR:"error",INVALID:"invalid",CHANGE:"change",ADD:"add",REMOVE:"remove",DESTROY:"destroy",RESET:"reset",SORT:"sort",REQUEST:"request",SYNC:"sync",ROUTE:"route",ALL:"all"}),e.EventDispatcher=e.Class.extend({trigger:function(a){if(!a)throw new Error("Event undefined");if(!c.isString(a)&&a instanceof e.Event||(a=new e.Event(a)),!this._queue||!(a.type in this._queue)&&!this._queue.all)return this;a.target||(a.target=this),a.currentTarget=this;var b=c.union(this._queue[a.type]||[],this._queue.all||[]);if(!b||!b.length)return this;for(var d=0,f=b.length;f>d;++d){var g=b[d],h=g.handler.call(g.scope||this,a);if(g.once&&this._off(a.type,g.handler,g.scope),h===!1||a.immediatePropagationStopped)break}return this},on:function(a,b,d,e){if(!a)throw new Error("Event type undefined");if(!b||!c.isFunction(b))throw new Error("Event handler is undefined or not a function");return c.isString(a)&&(a=a.split(" ")),c.isArray(a)?c.each(a,function(a){this._on(a,b,d,e,!1)},this):c.each(a,function(a,b){this._on(b,a,d,e,!1)},this),this},one:function(a,b,d,e){if(!a)throw new Error("Event type undefined");if(!b||!c.isFunction(b))throw new Error("Event handler is undefined or not a function");return c.isString(a)&&(a=a.split(" ")),c.isArray(a)?c.each(a,function(a){this._on(a,b,d,e,!0)},this):c.each(a,function(a,b){this._on(b,a,d,e,!0)},this),this},off:function(a,b){if(!arguments.length)return this._queue={},this;if(!a)throw new Error("Event type undefined");if(2==arguments.length&&!b)return this;var d=arguments;return c.isString(a)&&(a=a.split(" ")),c.isArray(a)?c.each(a,function(){this._off.apply(this,d)},this):c.each(a,function(){this._off.apply(this,d)},this),this},toString:function(){return"conbo.EventDispatcher"},dispatchEvent:function(){this.trigger.apply(this,arguments)},addEventListener:function(){this.on.apply(this,arguments)},removeEventListener:function(){this.off.apply(this,arguments)},_on:function(a,b,c,d,e){"*"==a&&(a="all"),this._queue||(this._queue={}),this._off(a,b,c),a in this._queue||(this._queue[a]=[]),this._queue[a].push({handler:b,scope:c,once:e,priority:d||0}),this._queue[a].sort(function(a,b){return b.priority-a.priority})},_off:function(a,b,c){if(!(this._queue&&a in this._queue))return this;var d=this._queue[a];if(1==arguments.length)return delete this._queue[a],this;var e;for(e=0;e<d.length;e++)d[e].handler!=b&&d[e].handler||d[e].scope!=c&&d[e].scope||d.splice(e--,1);return this}}),e.Bindable=e.EventDispatcher.extend({get:function(a){var b=c.result(this,"_attributes");return c.result(b,a)},set:function(a,b,d){if(c.isObject(a))return c.each(a,function(a,b){this.set(b,a,d)},this),this;var f=c.result(this,"_attributes"),g=!1;if(d||(d={silent:!1}),d.unset?(g=c.has(f,a),delete f[a]):c.isFunction(f[a])?f[a]()!==b&&(f[a](b),g=!0):f[a]!=b&&(f[a]=b,g=!0),g&&!d.silent){var d={attribute:a,value:b,options:d};this.trigger(new e.ConboEvent("change:"+a,d)),this.trigger(new e.ConboEvent(e.ConboEvent.CHANGE,d))}return this},unset:function(a,d){return d=c.defaults({unset:!0},d),this.set(a,b,d)},toString:function(){return"conbo.Bindable"},_attributes:function(){return this}}),e.Context=e.EventDispatcher.extend({constructor:function(a){return this._commands={},this._singletons={},this.options=a||{},this.application=this.options.application,this.view=this.application,this.on(e.Event.ALL,this._allHandler),this.initialize.apply(this,arguments),this},initialize:function(){},mapCommand:function(a,b){if(!a)throw new Error("eventType cannot be undefined");if(!b)throw new Error("commandClass cannot be undefined");if(!(this._mapMulti(a,b,this.mapCommand)||this._commands[a]&&-1!=this._commands[a].indexOf(b)))return this._commands[a]=this._commands[a]||[],this._commands[a].push(b),this},unmapCommand:function(a,c){if(!a)throw new Error("eventType cannot be undefined");if(!this._mapMulti(a,c,this.unmapCommand)){if(c===b)return void delete this._commands[a];if(this._commands[a]){var d=this._commands[a].indexOf(c);if(-1!=d)return this._commands[a].splice(d,1),this}}},mapSingleton:function(a,b){if(!a)throw new Error("propertyName cannot be undefined");if(!b)throw new Error("singletonClass cannot be undefined");if(!this._mapMulti(a,b,this.mapSingleton))return this._singletons[a]=c.isFunction(b)?new b(arguments[2],arguments[3],arguments[4]):b,this},unmapSingleton:function(a){if(!a)throw new Error("propertyName cannot be undefined");if(!this._mapMulti(a,null,this.unmapSingleton)&&this._singletons[a])return delete this._singletons[a],this},addTo:function(a){return c.extend(a||{},{context:this})},injectSingletons:function(a){for(var c in a)a[c]===b&&(a[c]=this._singletons[c]);return this},toString:function(){return"conbo.Context"},_allHandler:function(a){var b=c.union(this._commands.all||[],this._commands[a.type]||[]);b.length&&c.each(b,function(b){this._executeCommand(b,a)},this)},_executeCommand:function(a,b){var c,d;return d={event:b},c=new a(this.addTo(d)),c.execute(),c=null,this},_mapMulti:function(a,b,d){if(c.isArray(a)||-1==a.indexOf(" "))return!1;var e=c.isArray(a)?a:a.split(" ");return c.each(e,function(a){d(a,b)},this),!0}}),e.Hash=e.Bindable.extend({constructor:function(a,b){this._inject(b),this._attributes=c.defaults({},a,c.result(this,"defaults")),this.initialize.apply(this,arguments)},toJSON:function(){return c.clone(this._attributes)},toString:function(){return"conbo.Hash"}});var f=["keys","values","pairs","invert","pick","omit","size"];c.each(f,function(a){c.has(c,a)&&(e.Hash.prototype[a]=function(){return c[a].apply(c,[this._attributes].concat(c.rest(arguments)))})}),e.Map=e.Hash,e.BindingUtils=e.Class.extend({},{bindEl:function(a,b,c,f){if(!(a instanceof e.Bindable))throw new Error("Source is not Bindable");return f=f||function(a){return"undefined"==typeof a?"":String(a)},d(c).each(function(c,e){var g=d(e),h=g[0].tagName;switch(h){case"INPUT":case"SELECT":case"TEXTAREA":var i=(g.attr("type")||h).toLowerCase();switch(i){case"checkbox":return g.prop("checked",Boolean(a.get(b))),a.on("change:"+b,function(a){g.prop("checked",Boolean(a.value))}),void g.on("input change",function(){a.set(b,g.is(":checked"))});case"radio":g.val()==a.get(b)&&g.prop("checked",!0),a.on("change:"+b,function(a){g.val()==a.value&&g.prop("checked",!0)});break;default:g.val(a.get(b)),a.on("change:"+b,function(a){g.val()!=a.value&&g.val(a.value)})}g.on("input change",function(){a.set(b,g.val()||g.html())});break;default:g.html(f(a.get(b))),a.on("change:"+b,function(a){var b=f(a.value);g.html(b)})}}),this},bindProperty:function(a,b,c,d,f){if(!(a instanceof e.Bindable))throw new Error("Source is not Bindable");return d||(d=b),a.on("change:"+b,function(a){return c instanceof e.Bindable?void c.set(d,a.value):void(c[d]=a.value)}),f&&c instanceof e.Bindable&&this.bindProperty(c,d,a,b),this},bindSetter:function(a,b,d){if(!(a instanceof e.Bindable))throw new Error("Source is not Bindable");if(!c.isFunction(d)){if(!d||!c.has(d,b))throw new Error("Invalid setter function");d=d[b]}return a.on("change:"+b,function(a){d(a.value)}),this},toString:function(){return"conbo.BindingUtils"}});var g=/^(\S+)\s*(.*)$/,h=["model","collection","el","id","attributes","className","tagName","events"];e.$.fn.cbData=function(){for(var a={},c=this.get()[0].attributes,d=0,e=0;e<c.length;++e)0==c[e].name.indexOf("cb-")&&(a[c[e].name.substr(3)]=c[e].value,++d);return d?a:b},e.$.expr[":"].cbAttr=function(a,b,c){var d=e.$(a),f=c[3].split(","),g=d.cbData();return g?g&&!f.length?!0:f[0]&&!f[1]?g.hasOwnProperty(f[0]):f[0]&&f[1]?g[f[0]]==f[1]:!1:!1},e.View=e.Bindable.extend({constructor:function(a){a=c.clone(a)||{},this.cid=c.uniqueId("view"),this._addStyle(),this._configure(a),this._ensureElement(),this._inject(a),this.initialize.apply(this,arguments),this.delegateEvents()},tagName:"div",$:function(a){return this.$el.find(a)},initialize:function(){},render:function(){return this},remove:function(){return this.$el.remove(),this.unbindView().off(),this},setElement:function(a,b){return this.$el&&this.undelegateEvents().unbindView(),this.$el=e.$(a),this.el=this.$el[0],b!==!1&&this.delegateEvents(),this instanceof e.Application||this.bindView(),this},appendView:function(a){if(arguments.length>1)return c.each(arguments,function(a){this.appendView(a)},this),this;if(!(a instanceof e.View))throw new Error("Parameter must be instance of conbo.View class");return this.$el.append(a.el),this},prependView:function(a){if(arguments.length>1)return c.each(arguments,function(a){this.prependView(a)},this),this;if(!(a instanceof e.View))throw new Error("Parameter must be instance of conbo.View class");return this.$el.prepend(a.el),this},mouseEnabled:function(){return this._setClass.apply(this,c.union(["conbo-disabled"],c.toArray(arguments)))},visible:function(){return this._setClass.apply(this,c.union(["conbo-invisible"],c.toArray(arguments)))},includeInLayout:function(){return this._setClass.apply(this,c.union(["conbo-excludeFromLayout"],c.toArray(arguments)))},bindView:function(){return this.$("[cb-bind]").each(this.bind(function(a,d){var f,g,h=this.$(d).cbData().bind,i=h.split("|"),j=i[0].split("."),k=i[1]&&c.isFunction(this[i[1]])?this[i[1]]:b;if(console.log(h,i),j.length>1?(f=this[j[0]],g=j[1]):(f=this,g=j[0]),!f)throw new Error(i[0]+" is not defined in this View");if(!g)throw new Error("Unable to bind to undefined property");e.BindingUtils.bindEl(f,g,d,k)})),this},unbindView:function(){return this},loadCSS:function(b,c){if(!("document"in a))return this;var d=e.$("<link>").attr({rel:"stylesheet",type:"text/css",href:b}),f=d[0],g="sheet"in f,h=g?"sheet":"styleSheet",i=g?"cssRules":"rules",j=setInterval(function(){try{f[h]&&f[h][i].length&&(clearInterval(j),clearTimeout(k),c(!0))}catch(a){}},10),k=setTimeout(function(){clearInterval(j),clearTimeout(k),d.remove(),c(!1)},15e3);return e.$("head").append(d),this},delegateEvents:function(a){if(a||(a=c.result(this,"events"))){this.undelegateEvents();for(var b in a){var d=a[b];if(c.isFunction(d)||(d=this[a[b]]),!d)throw new Error('Method "'+a[b]+'" does not exist');var e=b.match(g),f=e[1],h=e[2];d=c.bind(d,this),f+=".delegateEvents"+this.cid,""===h?this.$el.on(f,d):this.$el.on(f,h,d)}return this}},undelegateEvents:function(){return this.$el.off(".delegateEvents"+this.cid),this},toString:function(){return"conbo.View"},_addStyle:function(){if(e.style)return this;var a=e.$('<style type="text/css">.conbo-invisible { visibility:hidden !important; }.conbo-excludeFromLayout { display:none !important; }.conbo-disabled { pointer-events:none !important; }</style>');return e.$("head").append(a),e.style=a,this},_configure:function(a){this.options&&(a=c.extend({},c.result(this,"options"),a)),c.extend(this,c.pick(a,h)),this.options=a},_ensureElement:function(){if(this.el)this.setElement(c.result(this,"el"),!1),this.className&&this.$el.addClass(this.className);else{var a=c.extend({},c.result(this,"attributes"));this.id&&(a.id=c.result(this,"id")),this.className&&(a["class"]=c.result(this,"className"));var b=e.$("<"+c.result(this,"tagName")+">").attr(a);this.setElement(b,!1)}},_setClass:function(a,b){var d=c.rest(arguments);if(!d.length)return!this.$el.hasClass(a);var f=c.isString(b)||c.isElement(b)||b instanceof e.$,g=f?this.$(b):this.$el;return 1==d.length&&f?!g.hasClass(a):(2==d.length&&f&&(b=d[1]),g.removeClass(a),b||g.addClass(a),this)}}),e.Application=e.View.extend({contextClass:e.Context,constructor:function(b){if(b=c.clone(b)||{},b.application=this,b.namespace=b.namespace||a,this.prefix=b.prefix||this.prefix||"",this.context=b.context||new this.contextClass(b),this.namespace=b.namespace,!b.el){var d;for(var f in this.namespace)if(this instanceof this.namespace[f]){d=f;break}var g='[cb-app="'+this.addPrefix(d)+'"]',h=e.$(g)[0];h&&(b.el=h)}e.View.prototype.constructor.apply(this,arguments)},addPrefix:function(a){return a=a||"",this.prefix?this.prefix+"."+a:a},bindViews:function(){var a=this.prefix?'[cb-view^="'+this.addPrefix()+'"]':"[cb-view]";return this.$(a).each(this.bind(function(a,b){var d=this.$(b).cbData().view.replace(this.addPrefix(),""),e=this.namespace[d];c.isFunction(e)&&new e(this.context.addTo({el:b}))})),this},toString:function(){return"conbo.Application"}}),e.Command=e.EventDispatcher.extend({constructor:function(a){this._inject(a),this.event=this.options.event||{},this.initialize.apply(this,arguments)},initialize:function(){},execute:function(){},toString:function(){return"conbo.Command"}}),e.ServerApplication=e.Bindable.extend({contextClass:e.Context,constructor:function(a){a=a||{},a.application=this,this.context=a.context||new this.contextClass(a),this._inject(a),this.options=a,this.initialize.apply(this,arguments)},initialize:function(){},toString:function(){return"conbo.ServerApplication"}}),e.Model=e.Map.extend({constructor:function(a,b){var d=a||{};b||(b={}),this.cid=c.uniqueId("c"),this._attributes={},c.extend(this,c.pick(b,["url","urlRoot","collection"])),b.parse&&(d=this.parse(d,b)||{}),d=c.defaults({},d,c.result(this,"defaults")),this.set(d,b),this._inject(b),this.initialize.apply(this,arguments)},changed:null,validationError:null,idAttribute:"id",initialize:function(){},sync:function(){return e.sync.apply(this,arguments)},get:function(a){return this._attributes[a]},escape:function(a){return c.escape(this.get(a))},has:function(a){return null!=this.get(a)},set:function(a,b,d){var f,g,h,i,j,k,l,m;if(null==a)return this;if("object"==typeof a?(g=a,d=b):(g={})[a]=b,d||(d={}),!this._validate(g,d))return!1;h=d.unset,j=d.silent,i=[],k=this._changing,this._changing=!0,k||(this._previousAttributes=c.clone(this._attributes),this.changed={}),m=this._attributes,l=this._previousAttributes,this.idAttribute in g&&(this.id=g[this.idAttribute]);for(f in g)b=g[f],c.isEqual(m[f],b)||i.push(f),c.isEqual(l[f],b)?delete this.changed[f]:this.changed[f]=b,h?delete m[f]:m[f]=b;if(!j){i.length&&(this._pending=!0);for(var n=0,o=i.length;o>n;n++)this.trigger(new e.ConboEvent("change:"+i[n],{model:this,value:m[i[n]],options:d,attribute:i[n]}))}if(k)return this;if(!j)for(;this._pending;)this._pending=!1,this.trigger(new e.ConboEvent(e.ConboEvent.CHANGE,{model:this,options:d}));return this._pending=!1,this._changing=!1,this},unset:function(a,d){return this.set(a,b,c.extend({},d,{unset:!0}))},clear:function(a){var d={};for(var e in this._attributes)d[e]=b;return this.set(d,c.extend({},a,{unset:!0}))},hasChanged:function(a){return null==a?!c.isEmpty(this.changed):c.has(this.changed,a)},changedAttributes:function(a){if(!a)return this.hasChanged()?c.clone(this.changed):!1;var b,d=!1,e=this._changing?this._previousAttributes:this._attributes;for(var f in a)c.isEqual(e[f],b=a[f])||((d||(d={}))[f]=b);return d},previous:function(a){return null!=a&&this._previousAttributes?this._previousAttributes[a]:null},previousAttributes:function(){return c.clone(this._previousAttributes)},fetch:function(a){a=a?c.clone(a):{},a.parse===b&&(a.parse=!0);var d=this,f=a.success;return a.success=function(b){return d.set(d.parse(b,a),a)?(f&&f(d,b,a),void collection.trigger(new e.ConboEvent(e.ConboEvent.SYNC,{model:d,response:b,options:a}))):!1},i(this,a),this.sync("read",this,a)},save:function(a,d,e){var f,g,h,j=this._attributes;if(null==a||"object"==typeof a?(f=a,e=d):(f={})[a]=d,!(!f||e&&e.wait||this.set(f,e)))return!1;if(e=c.extend({validate:!0},e),!this._validate(f,e))return!1;f&&e.wait&&(this._attributes=c.extend({},j,f)),e.parse===b&&(e.parse=!0);var k=this,l=e.success;return e.success=function(a){k._attributes=j;var b=k.parse(a,e);return e.wait&&(b=c.extend(f||{},b)),c.isObject(b)&&!k.set(b,e)?!1:(l&&l(k,a,e),void k.trigger("sync",k,a,e))},i(this,e),g=this.isNew()?"create":e.patch?"patch":"update","patch"===g&&(e.attrs=f),h=this.sync(g,this,e),f&&e.wait&&(this._attributes=j),h},destroy:function(a){a=a?c.clone(a):{};var b=this,d=a.success,f=function(){this.trigger(new e.ConboEvent(e.ConboEvent.DESTROY,{model:this,collection:b.collection,options:a}))};if(a.success=function(c){(a.wait||b.isNew())&&f(),d&&d(b,c,a),b.isNew()||b.trigger("sync",b,c,a)},this.isNew())return a.success(),!1;i(this,a);var g=this.sync("delete",this,a);return a.wait||f(),g},url:function(){var a=c.result(this,"urlRoot")||c.result(this.collection,"url")||urlError();return this.isNew()?a:a+("/"===a.charAt(a.length-1)?"":"/")+encodeURIComponent(this.id)},parse:function(a){return a},clone:function(){return new this.constructor(this._attributes)},isNew:function(){return null==this.id},isValid:function(a){return this._validate({},c.extend(a||{},{validate:!0}))},toString:function(){return"conbo.Model"},_validate:function(a,b){if(!b.validate||!this.validate)return!0;a=c.extend({},this._attributes,a);var d=this.validationError=this.validate(a,b)||null;return d?(this.trigger(new e.ConboEvent(e.ConboEvent.INVALID,{model:this,error:d,options:c.extend(b||{},{validationError:d})})),!1):!0}});var i=function(a,b){var c=b.error;b.error=function(d){c&&c(a,d,b),a.trigger(new e.ConboEvent("error",{model:a,response:d,options:b}))}};e.Collection=e.EventDispatcher.extend({model:e.Model,constructor:function(a,d){d||(d={}),d.url&&(this.url=d.url),d.model&&(this.model=d.model),d.comparator!==b&&(this.comparator=d.comparator),this._reset(),this._inject(d),a&&this.reset(a,c.extend({silent:!0},d)),this.initialize.apply(this,arguments)},initialize:function(){},toJSON:function(a){return this.map(function(b){return b.toJSON(a)})},sync:function(){return e.sync.apply(this,arguments)},add:function(a,b){return this.set(a,c.defaults(b||{},{add:!0,merge:!1,remove:!1}))},remove:function(a,b){a=c.isArray(a)?a.slice():[a],b||(b={});var d,f,g,h;for(d=0,f=a.length;f>d;d++)h=this.get(a[d]),h&&(delete this._byId[h.id],delete this._byId[h.cid],g=this.indexOf(h),this.models.splice(g,1),this.length--,b.silent||(b.index=g,this.trigger(new e.ConboEvent(e.ConboEvent.REMOVE,{model:h,collection:this,options:b}))),this._removeReference(h));return this},set:function(a,b){b=c.defaults(b||{},{add:!0,remove:!0,merge:!0}),b.parse&&(a=this.parse(a,b)),c.isArray(a)||(a=a?[a]:[]);var d,e,f,g,h=!1,i=b.at,j=this.comparator&&null==i&&b.sort!==!1,k=c.isString(this.comparator)?this.comparator:null,l=[],m=[],n={};for(d=0,e=a.length;e>d;d++)(f=this._prepareModel(a[d],b))&&((g=this.get(f))?(b.remove&&(n[g.cid]=!0),b.merge&&(g.set(f.attributes,b),j&&!h&&g.hasChanged(k)&&(h=!0))):b.add&&(l.push(f),f.on("all",this._onModelEvent,this),this._byId[f.cid]=f,null!=f.id&&(this._byId[f.id]=f)));if(b.remove){for(d=0,e=this.length;e>d;++d)n[(f=this.models[d]).cid]||m.push(f);m.length&&this.remove(m,b)}if(l.length&&(j&&(h=!0),this.length+=l.length,null!=i?[].splice.apply(this.models,[i,0].concat(l)):[].push.apply(this.models,l)),h&&this.sort({silent:!0}),b.silent)return this;for(d=0,e=l.length;e>d;d++)(f=l[d]).trigger("add",f,this,b);return h&&this.trigger("sort",this,b),this},reset:function(a,b){b||(b={});for(var d=0,f=this.models.length;f>d;d++)this._removeReference(this.models[d]);return b.previousModels=this.models,this._reset(),this.add(a,c.extend({silent:!0},b)),b.silent||this.trigger(new e.ConboEvent(e.ConboEvent.RESET,{collection:this,options:b})),this},push:function(a,b){return a=this._prepareModel(a,b),this.add(a,c.extend({at:this.length},b)),a},pop:function(a){var b=this.at(this.length-1);return this.remove(b,a),b},unshift:function(a,b){return a=this._prepareModel(a,b),this.add(a,c.extend({at:0},b)),a},shift:function(a){var b=this.at(0);return this.remove(b,a),b},slice:function(a,b){return this.models.slice(a,b)},get:function(a){return null==a?b:(this._idAttr||(this._idAttr=this.model.prototype.idAttribute),this._byId[a.id||a.cid||a[this._idAttr]||a])},at:function(a){return this.models[a]},where:function(a,d){return c.isEmpty(a)?d?b:[]:this[d?"find":"filter"](function(b){for(var c in a)if(a[c]!==b.get(c))return!1;return!0})},findWhere:function(a){return this.where(a,!0)},sort:function(a){if(!this.comparator)throw new Error("Cannot sort a set without a comparator");return a||(a={}),c.isString(this.comparator)||1===this.comparator.length?this.models=this.sortBy(this.comparator,this):this.models.sort(c.bind(this.comparator,this)),a.silent||this.trigger(new e.ConboEvent(e.ConboEvent.SORT,{collection:this,options:a})),this},sortedIndex:function(a,b,d){b||(b=this.comparator);var e=c.isFunction(b)?b:function(a){return a.get(b)};return c.sortedIndex(this.models,a,e,d)},pluck:function(a){return c.invoke(this.models,"get",a)},fetch:function(a){a=a?c.clone(a):{},a.parse===b&&(a.parse=!0);var d=a.success,f=this;return a.success=function(b){var c=a.reset?"reset":"set";f[c](b,a),d&&d(f,b,a),f.trigger(new e.ConboEvent(e.ConboEvent.SYNC,{collection:f,response:b,options:a}))},i(this,a),this.sync("read",this,a)},create:function(a,b){if(b=b?c.clone(b):{},!(a=this._prepareModel(a,b)))return!1;b.wait||this.add(a,b);var d=this,e=b.success;return b.success=function(c){b.wait&&d.add(a,b),e&&e(a,c,b)},a.save(null,b),a},parse:function(a){return a},_reset:function(){this.length=0,this.models=[],this._byId={}},_prepareModel:function(a,b){if(a instanceof e.Model)return a.collection||(a.collection=this),a;b||(b={}),b.collection=this;var c=new this.model(a,b);return c._validate(a,b)?c:(this.trigger(new e.ConboEvent(e.ConboEvent.INVALID,{collection:this,attrs:a,options:b})),!1)},_removeReference:function(a){this===a.collection&&delete a.collection,a.off("all",this._onModelEvent,this)},_onModelEvent:function(a){(a.type!=e.ConboEvent.ADD&&a.type!=e.ConboEvent.REMOVE||a.collection==this)&&(a.type==e.ConboEvent.DESTROY&&this.remove(a.model,a.options),a.model&&a.type=="change:"+a.model.idAttribute&&(delete this._byId[a.model.previous(a.model.idAttribute)],null!=model.id&&(this._byId[model.id]=model)),this.trigger(a))},toString:function(){return"conbo.Collection"}});var j=["forEach","each","map","collect","reduce","foldl","inject","reduceRight","foldr","find","detect","filter","select","reject","every","all","some","any","include","contains","invoke","max","min","toArray","size","first","head","take","initial","rest","tail","drop","last","without","indexOf","shuffle","lastIndexOf","isEmpty","chain"];c.each(j,function(a){c.has(c,a)&&(e.Collection.prototype[a]=function(){var b=[].slice.call(arguments);return b.unshift(this.models),c[a].apply(c,b)})});var k=["groupBy","countBy","sortBy"];c.each(k,function(a){c.has(c,a)&&(e.Collection.prototype[a]=function(b,d){var e=c.isFunction(b)?b:function(a){return a.get(b)};return c[a](this.models,e,d)})});var l=/^[#\/]|\s+$/g,m=/^\/+|\/+$/g,n=/msie [\w.]+/,o=/\/$/;e.History=e.EventDispatcher.extend({started:!1,interval:50,constructor:function(b){this.handlers=[],this.bindAll("checkUrl"),"undefined"!=typeof a&&(this.location=a.location,this.history=a.history),this._inject(b),this.initialize.apply(this,arguments)},initialize:function(){},getHash:function(a){var b=(a||this).location.href.match(/#(.*)$/);return b?b[1]:""},getFragment:function(a,b){if(null==a)if(this._hasPushState||!this._wantsHashChange||b){a=this.location.pathname;var c=this.root.replace(o,"");a.indexOf(c)||(a=a.substr(c.length))}else a=this.getHash();return a.replace(l,"")},start:function(b){if(this.started)throw new Error("conbo.history has already been started");this.started=!0,this.options=c.extend({},{root:"/"},this.options,b),this.root=this.options.root,this._wantsHashChange=this.options.hashChange!==!1,this._wantsPushState=!!this.options.pushState,this._hasPushState=!!(this.options.pushState&&this.history&&this.history.pushState);var d=this.getFragment(),f=document.documentMode,g=n.exec(navigator.userAgent.toLowerCase())&&(!f||7>=f);this.root=("/"+this.root+"/").replace(m,"/"),g&&this._wantsHashChange&&(this.iframe=e.$('<iframe src="javascript:0" tabindex="-1" />').hide().appendTo("body")[0].contentWindow,this.navigate(d)),this._hasPushState?e.$(a).on("popstate",this.checkUrl):this._wantsHashChange&&"onhashchange"in a&&!g?e.$(a).on("hashchange",this.checkUrl):this._wantsHashChange&&(this._checkUrlInterval=setInterval(this.checkUrl,this.interval)),this.fragment=d;var h=this.location,i=h.pathname.replace(/[^\/]$/,"$&/")===this.root;return this._wantsHashChange&&this._wantsPushState&&!this._hasPushState&&!i?(this.fragment=this.getFragment(null,!0),this.location.replace(this.root+this.location.search+"#"+this.fragment),!0):(this._wantsPushState&&this._hasPushState&&i&&h.hash&&(this.fragment=this.getHash().replace(l,""),this.history.replaceState({},document.title,this.root+this.fragment+h.search)),this.options.silent?void 0:this.loadUrl())},stop:function(){e.$(a).off("popstate",this.checkUrl).off("hashchange",this.checkUrl),clearInterval(this._checkUrlInterval),this.started=!1},route:function(a,b){this.handlers.unshift({route:a,callback:b})},checkUrl:function(){var a=this.getFragment();return a===this.fragment&&this.iframe&&(a=this.getFragment(this.getHash(this.iframe))),a===this.fragment?!1:(this.iframe&&this.navigate(a),void(this.loadUrl()||this.loadUrl(this.getHash())))},loadUrl:function(a){var b=this.fragment=this.getFragment(a),d=c.any(this.handlers,function(a){return a.route.test(b)?(a.callback(b),!0):void 0});return d},navigate:function(a,b){if(!this.started)return!1;if(b&&b!==!0||(b={trigger:b}),a=this.getFragment(a||""),this.fragment!==a){this.fragment=a;var c=this.root+a;if(this._hasPushState)this.history[b.replace?"replaceState":"pushState"]({},document.title,c);else{if(!this._wantsHashChange)return this.location.assign(c);this._updateHash(this.location,a,b.replace),this.iframe&&a!==this.getFragment(this.getHash(this.iframe))&&(b.replace||this.iframe.document.open().close(),this._updateHash(this.iframe.location,a,b.replace))}b.trigger&&this.loadUrl(a)}},toString:function(){return"conbo.History"},_updateHash:function(a,b,c){if(c){var d=a.href.replace(/(javascript:|#).*$/,"");a.replace(d+"#/"+b)}else a.hash="#/"+b}}),e.history=new e.History;var p=/\((.*?)\)/g,q=/(\(\?)?:\w+/g,r=/\*\w+/g,s=/[\-{}\[\]+?.,\\\^$|#\s]/g;e.Router=e.EventDispatcher.extend({constructor:function(a){a||(a={}),a.routes&&(this.routes=a.routes),this._bindRoutes(),this._inject(a),this.initialize.apply(this,arguments)},initialize:function(){},route:function(a,b,d){return c.isRegExp(a)||(a=this._routeToRegExp(a)),d||(d=this[b]),c.isFunction(b)&&(d=b,b=""),d||(d=this[b]),e.history.route(a,this.bind(function(c){var f=this._extractParameters(a,c);d&&d.apply(this,f);var g={router:this,route:a,name:b,parameters:f};this.trigger(new e.ConboEvent("route:"+b,g));var h=new e.ConboEvent(e.ConboEvent.ROUTE,g);this.trigger(h),e.history.trigger(h)})),this},navigate:function(a,b){return e.history.navigate(a,b),this},toString:function(){return"conbo.Router"},_bindRoutes:function(){if(this.routes){this.routes=c.result(this,"routes");for(var a,b=c.keys(this.routes);null!=(a=b.pop());)this.route(a,this.routes[a])}},_routeToRegExp:function(a){return a=a.replace(s,"\\$&").replace(p,"(?:$1)?").replace(q,function(a,b){return b?a:"([^/]+)"}).replace(r,"(.*?)"),new RegExp("^"+a+"$")},_extractParameters:function(a,b){var d=a.exec(b).slice(1);return c.map(d,function(a){return a?decodeURIComponent(a):null})}}),e.sync=function(b,d,f){var g=t[b];c.defaults(f||(f={}),{emulateHTTP:e.emulateHTTP,emulateJSON:e.emulateJSON});var h={type:g,dataType:f.dataType||d.dataType||"json"};if(f.url||(h.url=c.result(d,"url")||urlError()),null!=f.data||!d||"create"!==b&&"update"!==b&&"patch"!==b||(h.contentType="application/json",h.data=JSON.stringify(f.attrs||d.toJSON(f))),f.emulateJSON&&(h.contentType="application/x-www-form-urlencoded",h.data=h.data?{model:h.data}:{}),f.emulateHTTP&&("PUT"===g||"DELETE"===g||"PATCH"===g)){h.type="POST",f.emulateJSON&&(h.data._method=g);var i=f.beforeSend;f.beforeSend=function(a){return a.setRequestHeader("X-HTTP-Method-Override",g),i?i.apply(this,arguments):void 0}}"GET"===h.type||f.emulateJSON||(h.processData=!1),"json"!=h.dataType&&(h.contentType=f.contentType||d.dataType||"application/json",h.processData=!1),"PATCH"!==h.type||!a.ActiveXObject||a.external&&a.external.msActiveXFilteringEnabled||(h.xhr=function(){return new ActiveXObject("Microsoft.XMLHTTP")});var j=f.xhr=e.ajax(c.extend(h,f));return d.trigger("request",d,j,f),j};var t={create:"POST",update:"PUT",patch:"PATCH","delete":"DELETE",read:"GET"};return e.ajax=function(){return e.$.ajax.apply(e.$,arguments)},e};if("undefined"!=typeof module&&module.exports){var d,e;try{d=require("lodash")}catch(f){try{d=require("underscore")}catch(f){throw new Error("Conbo.js requires underscore or lodash")}}try{e=require("jQuery")}catch(f){try{e=require("jquery")}catch(f){}}module.exports=c(d,e)}else"function"==typeof define&&define.amd?define("conbo",["underscore","jquery"],function(a,b){return c(a,b)}):a.conbo=c(a._,a.jQuery||a.Zepto||a.ender)}(this);